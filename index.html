<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYS Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase konfigur√°ci√≥
        const firebaseConfig = {
            apiKey: "AIzaSyBKEAA01f16INT22nX2fSV8YGOfB3fDuMw",
            authDomain: "ays-production-5ab41.firebaseapp.com",
            projectId: "ays-production-5ab41",
            storageBucket: "ays-production-5ab41.firebasestorage.app",
            messagingSenderId: "642343737324",
            appId: "1:642343737324:web:2a2f1bd9455cb83a2752c9"
        };
        
        // Firebase inicializ√°l√°s
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Global el√©r√©s
        window.db = db;
        window.auth = auth;
        window.firestore = { collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot };
        window.authFunctions = { signInWithEmailAndPassword, onAuthStateChanged, signOut };
    </script>

</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-50 min-h-screen p-4">
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-amber-50 to-orange-50 z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
            <div class="text-center mb-8">
                <img src="AYS_new.png" alt="AYS" class="w-48 h-auto mx-auto mb-4">
                <p class="text-amber-700 text-lg font-medium">Bejelentkez√©s sz√ºks√©ges</p>
            </div>
            
            <div id="loginError" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm"></div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="email@andyourstories.com">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jelsz√≥</label>
                    <input type="password" id="loginPassword" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                
                <button type="submit" id="loginButton"
                    class="w-full bg-amber-600 text-white px-6 py-3 rounded-lg hover:bg-amber-700 font-semibold text-lg transition">
                    Bejelentkez√©s
                </button>
            </form>
            
            <!-- Debug info (TEMPORARY) -->
            <div id="debugInfo" class="mt-4 p-3 bg-gray-100 rounded text-xs text-gray-600"></div>
        </div>
    </div>
    
    <!-- Loading indicator -->
    <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-8 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-amber-600 mx-auto mb-4"></div>
            <p class="text-amber-900 font-semibold">Adatok bet√∂lt√©se...</p>
        </div>
    </div>
    
    <div id="app" class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-3 md:p-6 mb-4 md:mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 md:gap-0">
                <div class="flex items-center gap-2 md:gap-4 w-full md:w-auto">
                    <img src="AYS_new.png" alt="AYS" class="h-8 md:h-12 w-auto flex-shrink-0">
                    <div class="flex-1 min-w-0">
                        <h1 class="text-lg md:text-2xl font-bold text-amber-900">Production</h1>
                        <p class="text-amber-700 text-xs md:text-sm">Gy√°rt√°s k√∂vet≈ë</p>
                    </div>
                    <button onclick="toggleBeallitasok()" class="md:hidden bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 font-semibold text-xs touch-manipulation flex-shrink-0">
                        ‚öôÔ∏è Be√°ll√≠t√°sok
                    </button>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-end">
                    <div id="userInfo" class="text-xs md:text-sm text-gray-600 truncate max-w-[150px] md:max-w-none"></div>
                    <button onclick="kijelentkezes()" class="bg-red-600 text-white px-3 md:px-4 py-2 rounded-lg hover:bg-red-700 font-semibold text-xs md:text-sm whitespace-nowrap flex-shrink-0 touch-manipulation">
                        Kijelentkez√©s
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab navig√°ci√≥ -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="flex border-b border-gray-200">
                <button id="gyartasTabBtn" onclick="switchTab('gyartas')" 
                    class="flex-1 px-3 md:px-6 py-3 md:py-4 text-center font-semibold transition border-b-2 border-amber-600 text-amber-900 text-sm md:text-base">
                    <span class="block md:hidden">üè≠</span>
                    <span class="hidden md:block">üè≠ Gy√°rt√°s</span>
                </button>
                <button id="kiszallitasTabBtn" onclick="switchTab('kiszallitas')" 
                    class="flex-1 px-3 md:px-6 py-3 md:py-4 text-center font-semibold transition border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm md:text-base">
                    <span class="block md:hidden">üì§</span>
                    <span class="hidden md:block">üì§ Kisz√°ll√≠t√°s</span>
                </button>
            </div>
        </div>

        <!-- Be√°ll√≠t√°sok modal -->
        <div id="beallitasokModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-amber-900">‚öôÔ∏è Be√°ll√≠t√°sok</h2>
                        <button onclick="toggleBeallitasok()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                    </div>

                    <div class="space-y-6">
                        <!-- Gyertya m√©retek -->
                        <div class="border-2 border-amber-200 rounded-lg p-3 md:p-4">
                            <h3 class="font-bold text-base md:text-lg text-amber-900 mb-3">Gyertya m√©retek</h3>
                            <div id="gyertyaMeretLista" class="space-y-2 mb-3"></div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="ujGyertyaMeret" placeholder="pl. XL (500g)" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                                <button onclick="meretHozzaad('gyertya')" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 whitespace-nowrap text-sm md:text-base">+ Hozz√°ad</button>
                            </div>
                        </div>

                        <!-- Spray m√©retek -->
                        <div class="border-2 border-blue-200 rounded-lg p-3 md:p-4">
                            <h3 class="font-bold text-base md:text-lg text-blue-900 mb-3">Room and Linen Spray m√©retek</h3>
                            <div id="sprayMeretLista" class="space-y-2 mb-3"></div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="ujSprayMeret" placeholder="pl. 500ml" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                                <button onclick="meretHozzaad('spray')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 whitespace-nowrap text-sm md:text-base">+ Hozz√°ad</button>
                            </div>
                        </div>

                        <!-- Diffuser m√©retek -->
                        <div class="border-2 border-green-200 rounded-lg p-3 md:p-4">
                            <h3 class="font-bold text-base md:text-lg text-green-900 mb-3">Reed Diffuser m√©retek</h3>
                            <div id="diffuserMeretLista" class="space-y-2 mb-3"></div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="ujDiffuserMeret" placeholder="pl. 1000ml" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                                <button onclick="meretHozzaad('diffuser')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 whitespace-nowrap text-sm md:text-base">+ Hozz√°ad</button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button onclick="toggleBeallitasok()" class="bg-amber-600 text-white px-6 py-2 rounded-lg hover:bg-amber-700 font-semibold">
                            Bez√°r√°s
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- R√©szleges c√≠mk√©z√©s modal -->
        <div id="reszlegesCimkezesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-purple-900 mb-4">üè∑Ô∏è R√©szleges c√≠mk√©z√©s</h2>
                    <div id="reszlegesCimkezesInfo" class="bg-purple-50 p-4 rounded-lg mb-4"></div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">H√°ny darabot c√≠mk√©zel?</label>
                        <input type="number" id="reszlegesMennyiseg" min="1" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="reszlegesCimkezesVegrehajt()" class="flex-1 bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 font-semibold">
                            C√≠mk√©z
                        </button>
                        <button onclick="reszlegesCimkezesModal(null)" class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            M√©gsem
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teljes c√≠mk√©z√©s meger≈ës√≠t≈ë modal -->
        <div id="teljesCimkezesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-green-900 mb-4">‚úì C√≠mk√©z√©s meger≈ës√≠t√©se</h2>
                    <div id="teljesCimkezesInfo" class="bg-green-50 p-4 rounded-lg mb-4"></div>
                    <div class="flex gap-2">
                        <button onclick="teljesCimkezesVegrehajt()" class="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 font-semibold">
                            ‚úì C√≠mk√©zem
                        </button>
                        <button onclick="teljesCimkezesModal(null)" class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            M√©gsem
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manu√°lis c√≠mke hozz√°ad√°s modal -->
        <div id="manualCimkeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">‚ûï C√≠mke k√©szlet hozz√°ad√°s</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Illat</label>
                            <select id="manualCimkeIllat" onchange="manualCimkeIllatChange()" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">V√°lassz megl√©v≈ë illatot...</option>
                            </select>
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-sm text-gray-600">vagy</span>
                                <button onclick="toggleUjIllatManual()" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                                    + √öj illat
                                </button>
                            </div>
                            <div id="ujIllatManualForm" class="hidden mt-2">
                                <input type="text" id="ujIllatManualNev" placeholder="√öj illat neve (pl. Levendula)" 
                                    class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Term√©k t√≠pus</label>
                            <select id="manualCimkeTermekTipus" onchange="updateManualCimkeMeret()" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">V√°lassz t√≠pust...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">M√©ret</label>
                            <select id="manualCimkeMeret" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">El≈ësz√∂r v√°lassz t√≠pust</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mennyis√©g (db)</label>
                            <input type="number" id="manualCimkeMennyiseg" min="1" placeholder="pl. 50"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button onclick="manualCimkeHozzaad()" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                            Hozz√°ad
                        </button>
                        <button onclick="toggleManualCimkeModal()" class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            M√©gsem
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manu√°lis k√©sz term√©k hozz√°ad√°s modal -->
        <div id="manualKeszTermekModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-emerald-900 mb-4">‚ûï K√©sz term√©k hozz√°ad√°sa</h2>
                    <p class="text-sm text-gray-600 mb-4">Polcon l√©v≈ë k√©sz term√©kek r√∂gz√≠t√©s√©hez (nem von le c√≠mk√©t)</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Illat</label>
                            <select id="manualKeszTermekIllat" onchange="manualKeszTermekIllatChange()" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">V√°lassz megl√©v≈ë illatot...</option>
                            </select>
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-sm text-gray-600">vagy</span>
                                <button onclick="toggleUjIllatManualKeszTermek()" class="text-sm text-emerald-600 hover:text-emerald-800 font-medium">
                                    + √öj illat
                                </button>
                            </div>
                            <div id="ujIllatManualKeszTermekForm" class="hidden mt-2">
                                <input type="text" id="ujIllatManualKeszTermekNev" placeholder="√öj illat neve (pl. Levendula)" 
                                    class="w-full px-4 py-2 border border-emerald-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Term√©k t√≠pus</label>
                            <select id="manualKeszTermekTermekTipus" onchange="updateManualKeszTermekMeret()" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">V√°lassz t√≠pust...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">M√©ret</label>
                            <select id="manualKeszTermekMeret" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">El≈ësz√∂r v√°lassz t√≠pust</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mennyis√©g (db)</label>
                            <input type="number" id="manualKeszTermekMennyiseg" min="1" placeholder="pl. 24"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button onclick="manualKeszTermekHozzaad()" class="flex-1 bg-emerald-600 text-white px-4 py-3 rounded-lg hover:bg-emerald-700 font-semibold">
                            Hozz√°ad
                        </button>
                        <button onclick="toggleManualKeszTermekModal()" class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            M√©gsem
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- K√©sz term√©k szerkeszt√©s modal -->
        <div id="szerkesztKeszTermekModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">‚úèÔ∏è Mennyis√©g szerkeszt√©se</h2>
                    <div id="szerkesztKeszTermekInfo" class="bg-blue-50 p-4 rounded-lg mb-4"></div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">√öj mennyis√©g (db)</label>
                        <div class="flex gap-2 items-center">
                            <button onclick="keszTermekMennyisegValtoztat(-1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold">
                                -
                            </button>
                            <input type="number" id="szerkesztKeszTermekMennyiseg" min="0" 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg text-center font-bold">
                            <button onclick="keszTermekMennyisegValtoztat(1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold">
                                +
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="keszTermekSzerkesztMent()" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                            Ment√©s
                        </button>
                        <button onclick="keszTermekSzerkesztBezar()" class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            M√©gsem
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Illat szerkeszt√©s modal -->
        <div id="illatSzerkesztesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-amber-900 mb-4">‚úèÔ∏è Illat szerkeszt√©se</h2>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">V√°laszd ki a szerkesztend≈ë illatot</label>
                        <select id="szerkesztIllatSelect" class="w-full px-4 py-2 border rounded-lg mb-4">
                            <option value="">V√°lassz illatot...</option>
                        </select>
                    </div>
                    <div id="szerkesztIllatForm" class="hidden">
                        <div class="bg-amber-50 p-4 rounded-lg mb-4">
                            <div class="text-sm text-gray-600 mb-1">Jelenlegi n√©v:</div>
                            <div id="szerkesztIllatJelenlegiNev" class="font-bold text-amber-900"></div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">√öj n√©v</label>
                            <input type="text" id="szerkesztIllatUjNev" 
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="illatSzerkesztMent()" class="flex-1 bg-amber-600 text-white px-4 py-3 rounded-lg hover:bg-amber-700 font-semibold">
                                Ment√©s
                            </button>
                            <button onclick="toggleIllatSzerkesztes()" class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                                M√©gsem
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kisz√°ll√≠t√°s modal -->
        <div id="kiszallitasModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">üí∞ Kisz√°ll√≠t√°s r√∂gz√≠t√©se</h2>
                    <div id="kiszallitasTermekInfo" class="bg-blue-50 p-4 rounded-lg mb-4"></div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">D√°tum</label>
                            <div class="flex gap-2">
                                <input type="date" id="kiszallitasDatum" 
                                    class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <button onclick="kiszallitasMaiDatum()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-medium text-sm whitespace-nowrap">
                                    üìÖ Mai d√°tum
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√≠pus</label>
                            <select id="kiszallitasTipus" class="w-full px-4 py-2 border rounded-lg">
                                <option value="eladas">üõí K√∂zvetlen elad√°s</option>
                                <option value="fulfilment">üì¶ Fulfilment</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mennyis√©g (db)</label>
                            <div class="flex gap-2 items-center">
                                <button onclick="kiszallitasMennyisegValtoztat(-1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold">
                                    -
                                </button>
                                <input type="number" id="kiszallitasMennyiseg" min="1" 
                                    class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-center font-bold text-lg">
                                <button onclick="kiszallitasMennyisegValtoztat(1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold">
                                    +
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Partner</label>
                            <select id="kiszallitasPartnerSelect" onchange="kiszallitasPartnerChange()" class="w-full px-4 py-2 border rounded-lg mb-2">
                                <option value="">V√°lassz partnert...</option>
                            </select>
                            <div id="ujPartnerForm" class="hidden">
                                <input type="text" id="ujPartnerNev" placeholder="√öj partner neve" 
                                    class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Megjegyz√©s (opcion√°lis)</label>
                            <textarea id="kiszallitasMegjegyzes" rows="2" placeholder="pl. Piacon eladva"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button onclick="kiszallitasRogzit()" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                            R√∂gz√≠t
                        </button>
                        <button onclick="kiszallitasModalBezar()" class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            M√©gsem
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Illat statisztika modal -->
        <div id="illatStatisztikaModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <h2 id="illatStatisztikaCim" class="text-xl font-bold text-amber-900 mb-4">üìä Illat statisztika</h2>
                    <div id="illatStatisztikaContent" class="space-y-4"></div>
                    <div class="mt-6">
                        <button onclick="illatStatisztikaModalBezar()" class="w-full px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                            Bez√°r
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- √öj kisz√°ll√≠t√°s modal -->
        <div id="ujKiszallitasModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">üì¶ √öj kisz√°ll√≠t√°s l√©trehoz√°sa</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">D√°tum</label>
                            <div class="flex gap-2">
                                <input type="date" id="ujKiszallitasDatum" 
                                    class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <button onclick="ujKiszallitasMaiDatum()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-medium text-sm whitespace-nowrap">
                                    üìÖ Mai
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√≠pus</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="ujKiszallitasTipusValaszt('eladas')" id="tipusEladasBtn"
                                    class="px-6 py-4 rounded-lg font-bold text-lg border-2 border-green-500 bg-green-50 text-green-700 hover:bg-green-100">
                                    üõí Elad√°s
                                </button>
                                <button onclick="ujKiszallitasTipusValaszt('fulfilment')" id="tipusFulfilmentBtn"
                                    class="px-6 py-4 rounded-lg font-bold text-lg border-2 border-gray-300 bg-gray-50 text-gray-600 hover:bg-gray-100">
                                    üì¶ Fulfilment
                                </button>
                            </div>
                            <input type="hidden" id="ujKiszallitasTipus" value="eladas">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Partner</label>
                            <select id="ujKiszallitasPartnerSelect" onchange="ujKiszallitasPartnerChange()" class="w-full px-4 py-2 border rounded-lg mb-2">
                                <option value="">V√°lassz partnert...</option>
                            </select>
                            <div id="ujKiszallitasUjPartnerForm" class="hidden">
                                <input type="text" id="ujKiszallitasUjPartnerNev" placeholder="√öj partner neve" 
                                    class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Megjegyz√©s (opcion√°lis)</label>
                            <textarea id="ujKiszallitasMegjegyzes" rows="2" placeholder="pl. Piacon eladva"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button onclick="ujKiszallitasLetrehoz()" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                            L√©trehoz
                        </button>
                        <button onclick="ujKiszallitasModalBezar()" class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            M√©gsem
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kisz√°ll√≠t√°s szerkeszt√©s modal -->
        <div id="kiszallitasSzerkesztModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-blue-900 mb-4">‚úèÔ∏è Kisz√°ll√≠t√°s szerkeszt√©se</h2>
                    <div id="szerkesztKiszallitasInfo" class="bg-blue-50 p-4 rounded-lg mb-4"></div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√≠pus</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="szerkesztTipusValaszt('eladas')" id="szerkesztTipusEladasBtn"
                                    class="px-6 py-3 rounded-lg font-bold border-2">
                                    üõí Elad√°s
                                </button>
                                <button onclick="szerkesztTipusValaszt('fulfilment')" id="szerkesztTipusFulfilmentBtn"
                                    class="px-6 py-3 rounded-lg font-bold border-2">
                                    üì¶ Fulfilment
                                </button>
                            </div>
                            <input type="hidden" id="szerkesztTipus">
                            <input type="hidden" id="szerkesztKiszallitasId">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Partner</label>
                            <select id="szerkesztPartnerSelect" class="w-full px-4 py-2 border rounded-lg">
                                <option value="">V√°lassz partnert...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mennyis√©g (db)</label>
                            <div class="flex gap-2 items-center">
                                <button onclick="szerkesztMennyisegValtoztat(-1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold">
                                    -
                                </button>
                                <input type="number" id="szerkesztMennyiseg" min="1" 
                                    class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-center font-bold text-lg">
                                <button onclick="szerkesztMennyisegValtoztat(1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold">
                                    +
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">D√°tum</label>
                            <input type="date" id="szerkesztDatum" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Megjegyz√©s</label>
                            <textarea id="szerkesztMegjegyzes" rows="2" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button onclick="kiszallitasSzerkesztMent()" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                            Ment√©s
                        </button>
                        <button onclick="kiszallitasSzerkesztModalBezar()" class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            M√©gsem
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GY√ÅRT√ÅS TAB -->
        <div id="gyartasTab">
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Illatok kezel√©se -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-amber-900">Illatok</h2>
                    <div class="flex gap-2">
                        <button onclick="toggleUjIllat()" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition text-sm">
                            + √öj illat
                        </button>
                        <button onclick="toggleIllatSzerkesztes()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm">
                            ‚úèÔ∏è Szerkeszt
                        </button>
                    </div>
                </div>

                <div id="ujIllatForm" class="mb-4 p-4 bg-amber-50 rounded-lg hidden">
                    <input
                        type="text"
                        id="ujIllatNev"
                        placeholder="Illat neve (pl. Van√≠lia)"
                        class="w-full px-4 py-2 border border-amber-300 rounded-lg mb-2 focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                    />
                    <div class="flex gap-2">
                        <button onclick="illatHozzaad()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex-1">
                            Hozz√°ad
                        </button>
                        <button onclick="toggleUjIllat()" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition">
                            M√©gsem
                        </button>
                    </div>
                </div>

                <div id="illatLista" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>

            <!-- √öj term√©k r√∂gz√≠t√©se -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-amber-900 mb-4">√öj term√©k r√∂gz√≠t√©se</h2>
                
                <div id="kiontesForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Term√©k t√≠pus</label>
                        <select id="termekTipus" onchange="updateMeretOptions()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                            <option value="">V√°lassz term√©k t√≠pust...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">M√©ret</label>
                        <select id="meret" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                            <option value="">El≈ësz√∂r v√°lassz term√©k t√≠pust</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Illat</label>
                        <select id="kivalasztottIllat" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                            <option value="">V√°lassz illatot...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Darabsz√°m</label>
                        <input
                            type="number"
                            id="darabszam"
                            min="1"
                            placeholder="H√°ny darabot k√©sz√≠tett√©l?"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Megjegyz√©s (opcion√°lis)</label>
                        <input
                            type="text"
                            id="megjegyzes"
                            placeholder="pl. k√ºl√∂nleges sorozat, aj√°nd√©k csomag"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                        />
                    </div>

                    <button onclick="kiontesHozzaad()" class="w-full bg-amber-600 text-white px-6 py-3 rounded-lg hover:bg-amber-700 transition font-semibold">
                        Term√©k r√∂gz√≠t√©se
                    </button>
                </div>
            </div>
        </div>

        <!-- C√≠mke √∂sszes√≠t√©s -->
        <div id="cimkeOsszesites" class="mb-6"></div>

        <!-- C√≠mke nyomtat√°s -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-amber-900">üñ®Ô∏è C√≠mke nyomtat√°s (12 db / lap)</h2>
                <button onclick="toggleManualCimkeModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-semibold">
                    ‚ûï Manu√°lis hozz√°ad√°s
                </button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Gyors nyomtat√°s lista -->
                <div>
                    <h3 class="font-semibold text-gray-700 mb-3">Gyors nyomtat√°s (ki√∂nt√∂tt term√©kek alapj√°n)</h3>
                    <div id="gyorsNyomtatasLista" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>

                <!-- C√≠mke k√©szlet -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="font-bold text-blue-900 mb-3">üì¶ C√≠mke k√©szlet</h3>
                    <div id="cimkeKeszletLista" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Term√©kek list√°ja -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-amber-900">üìã C√≠mk√©zetlen term√©kek</h2>
                <button onclick="scrollToProductForm()" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 text-sm font-semibold">
                    ‚ûï √öj term√©k
                </button>
            </div>
            <div id="kiontesLista" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>

        <!-- K√©sz term√©kek -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-4">
                <h2 class="text-xl font-bold text-amber-900">‚úÖ K√©sz c√≠mk√©zett term√©kek</h2>
                <div class="flex gap-2 items-center flex-wrap">
                    <button onclick="toggleManualKeszTermekModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 text-sm font-semibold">
                        ‚ûï K√©sz term√©k hozz√°ad√°sa
                    </button>
                    <label class="text-sm text-gray-600">Rendez√©s:</label>
                    <select id="keszTermekRendezes" onchange="keszTermekRendezesValtozas()" class="px-3 py-1.5 border rounded-lg text-sm">
                        <option value="datum">D√°tum (legfrissebb)</option>
                        <option value="abc">N√©v (ABC)</option>
                        <option value="mennyiseg">Mennyis√©g (t√∂bb‚Üíkevesebb)</option>
                    </select>
                </div>
            </div>
            
            <!-- K√©szlet √∂sszes√≠t≈ë -->
            <div id="keszTermekOsszesito" class="mb-4"></div>
            
            <div id="keszTermekekLista" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>
        </div>
        <!-- GY√ÅRT√ÅS TAB V√âGE -->

        <!-- KISZ√ÅLL√çT√ÅS TAB -->
        <div id="kiszallitasTab" class="hidden">
        
            <!-- Draft kisz√°ll√≠t√°s doboz -->
            <div id="draftDoboz" class="hidden mb-6"></div>
        
            <!-- Kisz√°ll√≠t√°si statisztika -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-blue-900 mb-4">üìä Kisz√°ll√≠t√°si statisztika</h2>
                
                <!-- Id≈ëszak gombok -->
                <div class="flex gap-2 mb-4 flex-wrap">
                    <button onclick="statisztikaIdoszakValtoztat('heti')" id="statHeti" 
                        class="px-4 py-2 rounded-lg font-medium bg-blue-600 text-white">
                        Heti
                    </button>
                    <button onclick="statisztikaIdoszakValtoztat('havi')" id="statHavi"
                        class="px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                        Havi
                    </button>
                    <button onclick="statisztikaIdoszakValtoztat('evi')" id="statEvi"
                        class="px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                        √âvi
                    </button>
                    <button onclick="toggleEgyeniIdoszak()" id="statEgyeni"
                        class="px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300">
                        üìÖ Egy√©ni id≈ëszak
                    </button>
                </div>
                
                <!-- Egy√©ni id≈ëszak form (hidden) -->
                <div id="egyeniIdoszakForm" class="hidden mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="grid md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">D√°tumt√≥l</label>
                            <input type="date" id="statDatumTol" class="w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">D√°tumig</label>
                            <input type="date" id="statDatumIg" class="w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                    </div>
                    <button onclick="egyeniIdoszakAlkalmaz()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm">
                        Alkalmaz
                    </button>
                </div>
                
                <!-- Statisztika adatok -->
                <div id="statisztikaAdatok" class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border-2 border-blue-200"></div>
            </div>
            
            <!-- √öj kisz√°ll√≠t√°s gomb -->
            <div class="mb-6">
                <button onclick="ujKiszallitasModal()" class="w-full md:w-auto bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold text-lg shadow-lg">
                    üì¶ √öj kisz√°ll√≠t√°s ind√≠t√°sa
                </button>
            </div>

            <!-- Kisz√°ll√≠t√°sok √∂sszes√≠t≈ë -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold text-blue-900 mb-4">üìä Kisz√°ll√≠t√°s √∂sszes√≠t≈ë</h2>
                <div id="kiszallitasOsszesito" class="grid md:grid-cols-3 gap-4"></div>
            </div>

            <!-- Kisz√°ll√≠t√°sok t√∂rt√©nete -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-blue-900 mb-4">üì¶ Kisz√°ll√≠t√°sok t√∂rt√©nete</h2>
                
                <!-- Sz≈±r≈ëk -->
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">T√≠pus</label>
                            <select id="szuroTipus" onchange="renderKiszallitasok()" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="">√ñsszes</option>
                                <option value="eladas">üõí Elad√°s</option>
                                <option value="fulfilment">üì¶ Fulfilment</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Partner</label>
                            <select id="szuroPartner" onchange="renderKiszallitasok()" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="">√ñsszes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Term√©k (illat)</label>
                            <select id="szuroTermek" onchange="renderKiszallitasok()" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="">√ñsszes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">M≈±velet</label>
                            <button onclick="szurokTorlese()" class="w-full px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium">
                                üîÑ Sz≈±r≈ëk t√∂rl√©se
                            </button>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">D√°tumt√≥l</label>
                            <input type="date" id="szuroDatumTol" onchange="renderKiszallitasok()" class="w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">D√°tumig</label>
                            <input type="date" id="szuroDatumIg" onchange="renderKiszallitasok()" class="w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                    </div>
                </div>
                
                <div id="kiszallitasokLista" class="space-y-3 max-h-[600px] overflow-y-auto"></div>
            </div>
        </div>
        <!-- KISZ√ÅLL√çT√ÅS TAB V√âGE -->
    </div>

    <script>
        let illatok = [];
        let kiontesek = [];
        let cimkeKeszlet = {}; // C√≠mke k√©szlet t√°rol√°sa: { "illatId-termekTipus-meret": darabszam }
        let keszTermekek = []; // C√≠mk√©zett k√©sz term√©kek
        let kiszallitasok = []; // Kisz√°ll√≠t√°sok
        let partnerek = []; // Partnerek list√°ja
        let aktivDraft = null; // Akt√≠v kisz√°ll√≠t√°s draft
        let idCounter = 0; // Egyedi ID sz√°ml√°l√≥
        let keszTermekRendezes = 'datum'; // Rendez√©si m√≥d: datum, abc, mennyiseg
        let akt√≠vTab = 'gyartas'; // Akt√≠v tab k√∂vet√©se
        let statisztikaIdoszak = 'heti'; // Statisztika id≈ëszak: heti, havi, evi, egyeni
        
        // Term√©k t√≠pusok √©s m√©retek
        const termekTipusok = [
            { id: 'gyertya', nev: 'Gyertya' },
            { id: 'spray', nev: 'Room and Linen Spray' },
            { id: 'diffuser', nev: 'Reed Diffuser' }
        ];
        
        // Alap√©rtelmezett m√©retek
        const alapMeretek = {
            gyertya: ['Kis (120g)', 'K√∂zepes (180g)', 'Nagy (250g)', 'Extra nagy (400g)'],
            spray: ['50ml', '100ml', '250ml'],
            diffuser: ['100ml', '200ml', '500ml']
        };
        
        let meretek = {};
        
        // Egyedi ID gener√°l√°s
        function generateId() {
            return Date.now() + (idCounter++);
        }

        // Firebase bet√∂lt√©s
        // ===== AUTHENTICATION =====
        
        let jelenlegiUser = null;
        
        // Wait for DOM and Firebase to be ready
        document.addEventListener('DOMContentLoaded', () => {
            // Check if auth is available
            if (!window.auth || !window.authFunctions) {
                console.error('Firebase Auth not loaded!');
                document.getElementById('debugInfo').textContent = '‚ùå Firebase Auth nem t√∂lt≈ëd√∂tt be!';
                return;
            }
            
            document.getElementById('debugInfo').textContent = '‚úÖ Firebase Auth bet√∂ltve, v√°rakoz√°s...';
            
            // Authentication state listener
            window.authFunctions.onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    // Bejelentkezve
                    jelenlegiUser = user;
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('userInfo').textContent = user.email;
                    document.getElementById('loadingIndicator').classList.remove('hidden');
                    
                    // Adatok bet√∂lt√©se √âS ut√°na render
                    betolt().then(() => {
                        document.getElementById('loadingIndicator').classList.add('hidden');
                        document.getElementById('app').style.display = 'block';
                        render(); // Most h√≠vjuk meg amikor az adatok megvannak!
                    });
                } else {
                    // Nincs bejelentkezve
                    jelenlegiUser = null;
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('app').style.display = 'none';
                    document.getElementById('debugInfo').textContent = 'V√°rakoz√°s bejelentkez√©sre...';
                }
            });
            
            // Login form handler
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');
                const loginButton = document.getElementById('loginButton');
                const debugDiv = document.getElementById('debugInfo');
                
                // Debug output
                debugDiv.textContent = 'Bejelentkez√©s pr√≥b√°lkoz√°s...';
                
                // Hide previous errors
                errorDiv.classList.add('hidden');
                
                // Disable button
                loginButton.disabled = true;
                loginButton.textContent = 'Bejelentkez√©s...';
                
                try {
                    debugDiv.textContent = 'Firebase signIn h√≠v√°s...';
                    const userCredential = await window.authFunctions.signInWithEmailAndPassword(window.auth, email, password);
                    debugDiv.textContent = '‚úÖ Sikeres bejelentkez√©s! User: ' + userCredential.user.email;
                    // Success - onAuthStateChanged will handle the rest
                } catch (error) {
                    console.error('Login error:', error);
                    debugDiv.textContent = '‚ùå Hiba: ' + error.code + ' - ' + error.message;
                    
                    // Show error message
                    let errorMessage = 'Hiba t√∂rt√©nt a bejelentkez√©s sor√°n.';
                    
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Hib√°s email vagy jelsz√≥!';
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = 'Nincs ilyen felhaszn√°l√≥!';
                    } else if (error.code === 'auth/user-disabled') {
                        errorMessage = 'Ez a fi√≥k le van tiltva!';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'T√∫l sok sikertelen pr√≥b√°lkoz√°s! Pr√≥b√°ld k√©s≈ëbb.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = '√ârv√©nytelen email c√≠m!';
                    }
                    
                    errorDiv.textContent = errorMessage;
                    errorDiv.classList.remove('hidden');
                    
                    // Re-enable button
                    loginButton.disabled = false;
                    loginButton.textContent = 'Bejelentkez√©s';
                }
            });
        });
        
        // Logout function
        function kijelentkezes() {
            // Vizu√°lis meger≈ës√≠t√©s modal
            const modalHTML = `
                <div id="logoutConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-3">Biztosan kijelentkezel?</h3>
                        <div class="flex gap-3 mt-4">
                            <button onclick="confirmLogout()" class="flex-1 bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 font-semibold touch-manipulation">
                                Kijelentkez√©s
                            </button>
                            <button onclick="closeLogoutModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-400 font-semibold touch-manipulation">
                                M√©gsem
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function confirmLogout() {
            window.authFunctions.signOut(window.auth);
            closeLogoutModal();
        }
        
        function closeLogoutModal() {
            const modal = document.getElementById('logoutConfirmModal');
            if (modal) modal.remove();
        }
        
        // Make logout functions global
        window.kijelentkezes = kijelentkezes;
        window.confirmLogout = confirmLogout;
        window.closeLogoutModal = closeLogoutModal;

        // ===== DATA LOADING =====

        async function betolt() {
            try {
                // Illatok bet√∂lt√©se
                const illatokDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'appData', 'illatok'));
                if (illatokDoc.exists()) {
                    illatok = illatokDoc.data().data || [];
                }
                
                // Ki√∂nt√©sek bet√∂lt√©se
                const kiontesekDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'appData', 'kiontesek'));
                if (kiontesekDoc.exists()) {
                    kiontesek = kiontesekDoc.data().data || [];
                }
                
                // M√©retek bet√∂lt√©se
                const meretekDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'appData', 'meretek'));
                if (meretekDoc.exists()) {
                    meretek = meretekDoc.data().data || {};
                } else {
                    // Ha nincs mentett, haszn√°ljuk az alap√©rtelmezett m√©reteket
                    meretek = JSON.parse(JSON.stringify(alapMeretek));
                    await ment(); // Ments√ºk el az alap√©rtelmezetteket
                }
                
                // C√≠mke k√©szlet bet√∂lt√©se
                const cimkeKeszletDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'appData', 'cimkeKeszlet'));
                if (cimkeKeszletDoc.exists()) {
                    cimkeKeszlet = cimkeKeszletDoc.data().data || {};
                }
                
                // K√©sz term√©kek bet√∂lt√©se
                const keszTermekekDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'appData', 'keszTermekek'));
                if (keszTermekekDoc.exists()) {
                    keszTermekek = keszTermekekDoc.data().data || [];
                }
                
                // Kisz√°ll√≠t√°sok bet√∂lt√©se
                const kiszallitasokDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'appData', 'kiszallitasok'));
                if (kiszallitasokDoc.exists()) {
                    kiszallitasok = kiszallitasokDoc.data().data || [];
                }
                
                // Partnerek bet√∂lt√©se
                const partnerekDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'appData', 'partnerek'));
                if (partnerekDoc.exists()) {
                    partnerek = partnerekDoc.data().data || [];
                }
                
                // Akt√≠v draft bet√∂lt√©se
                const aktivDraftDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'appData', 'aktivDraft'));
                if (aktivDraftDoc.exists()) {
                    aktivDraft = aktivDraftDoc.data().data || null;
                }
                
                render();
                renderDraftDoboz();
                
                // Loading indicator elrejt√©se
                document.getElementById('loadingIndicator').classList.add('hidden');
            } catch (error) {
                console.error('Bet√∂lt√©si hiba:', error);
                document.getElementById('loadingIndicator').classList.add('hidden');
                alert('Hiba t√∂rt√©nt az adatok bet√∂lt√©se k√∂zben! Ellen≈ërizd az internet kapcsolatot.');
            }
        }

        // ===== KISZ√ÅLL√çT√ÅS DRAFT √âS STATISZTIKA FUNKCI√ìK =====
        
        let statisztikaEgyeniTol = null;
        let statisztikaEgyeniIg = null;
        
        function statisztikaIdoszakValtoztat(idoszak) {
            statisztikaIdoszak = idoszak;
            
            // Gombok friss√≠t√©se
            ['statHeti', 'statHavi', 'statEvi', 'statEgyeni'].forEach(id => {
                const btn = document.getElementById(id);
                if (id === 'stat' + idoszak.charAt(0).toUpperCase() + idoszak.slice(1)) {
                    btn.className = 'px-4 py-2 rounded-lg font-medium bg-blue-600 text-white';
                } else {
                    btn.className = 'px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300';
                }
            });
            
            document.getElementById('egyeniIdoszakForm').classList.add('hidden');
            renderStatisztika();
        }
        
        function toggleEgyeniIdoszak() {
            const form = document.getElementById('egyeniIdoszakForm');
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                statisztikaIdoszak = 'egyeni';
                // Gombok friss√≠t√©se
                ['statHeti', 'statHavi', 'statEvi'].forEach(id => {
                    document.getElementById(id).className = 'px-4 py-2 rounded-lg font-medium bg-gray-200 text-gray-700 hover:bg-gray-300';
                });
                document.getElementById('statEgyeni').className = 'px-4 py-2 rounded-lg font-medium bg-blue-600 text-white';
            }
        }
        
        function egyeniIdoszakAlkalmaz() {
            const tol = document.getElementById('statDatumTol').value;
            const ig = document.getElementById('statDatumIg').value;
            
            if (!tol || !ig) {
                alert('K√©rlek add meg mindk√©t d√°tumot!');
                return;
            }
            
            statisztikaEgyeniTol = tol;
            statisztikaEgyeniIg = ig;
            renderStatisztika();
        }
        
        function renderStatisztika() {
            const container = document.getElementById('statisztikaAdatok');
            
            // Id≈ëszak kisz√°m√≠t√°sa
            let datumTol, datumIg;
            const ma = new Date();
            
            if (statisztikaIdoszak === 'heti') {
                datumTol = new Date(ma.getTime() - 7 * 24 * 60 * 60 * 1000);
                datumIg = ma;
            } else if (statisztikaIdoszak === 'havi') {
                datumTol = new Date(ma.getFullYear(), ma.getMonth(), 1);
                datumIg = ma;
            } else if (statisztikaIdoszak === 'evi') {
                datumTol = new Date(ma.getFullYear(), 0, 1);
                datumIg = ma;
            } else if (statisztikaIdoszak === 'egyeni') {
                if (!statisztikaEgyeniTol || !statisztikaEgyeniIg) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">V√°lassz d√°tumokat az egy√©ni id≈ëszakhoz</p>';
                    return;
                }
                datumTol = new Date(statisztikaEgyeniTol);
                datumIg = new Date(statisztikaEgyeniIg + 'T23:59:59');
            }
            
            // Sz≈±rt kisz√°ll√≠t√°sok
            const szurtKiszallitasok = kiszallitasok.filter(k => {
                const kDatum = new Date(k.datum);
                return kDatum >= datumTol && kDatum <= datumIg;
            });
            
            if (szurtKiszallitasok.length === 0) {
                container.innerHTML = `
                    <p class="text-gray-600 font-medium">${formatDatum(datumTol.toISOString())} - ${formatDatum(datumIg.toISOString())}</p>
                    <p class="text-gray-500 text-sm mt-2">Nincs kisz√°ll√≠t√°s ebben az id≈ëszakban</p>
                `;
                return;
            }
            
            // T√≠pusonk√©nt √∂sszes√≠t√©s
            const tipusonkent = {};
            szurtKiszallitasok.forEach(k => {
                const kulcs = `${k.termekTipusNev} - ${k.meret}`;
                tipusonkent[kulcs] = (tipusonkent[kulcs] || 0) + k.mennyiseg;
            });
            
            // Elad√°s/Fulfilment
            const eladas = szurtKiszallitasok.filter(k => k.tipus === 'eladas').reduce((sum, k) => sum + k.mennyiseg, 0);
            const fulfilment = szurtKiszallitasok.filter(k => k.tipus === 'fulfilment').reduce((sum, k) => sum + k.mennyiseg, 0);
            const osszes = eladas + fulfilment;
            
            // Rendez√©s ABC szerint
            const tipusokRendezve = Object.entries(tipusonkent).sort(([a], [b]) => a.localeCompare(b, 'hu'));
            
            container.innerHTML = `
                <div class="text-sm font-semibold text-blue-900 mb-2">
                    ${formatDatum(datumTol.toISOString())} - ${formatDatum(datumIg.toISOString())}
                </div>
                <div class="mb-3">
                    ${tipusokRendezve.map(([tipus, db]) => 
                        `<div class="text-sm text-gray-700">‚Ä¢ ${tipus}: <span class="font-bold">${db} db</span></div>`
                    ).join('')}
                </div>
                <div class="border-t-2 border-blue-300 pt-2 mb-2"></div>
                <div class="flex justify-between items-center text-sm mb-1">
                    <span class="text-gray-700">Elad√°s:</span>
                    <span class="font-bold text-green-700">${eladas} db üõí</span>
                </div>
                <div class="flex justify-between items-center text-sm mb-2">
                    <span class="text-gray-700">Fulfilment:</span>
                    <span class="font-bold text-blue-700">${fulfilment} db üì¶</span>
                </div>
                <div class="border-t-2 border-blue-300 pt-2"></div>
                <div class="flex justify-between items-center font-bold text-blue-900">
                    <span>√ñSSZESEN:</span>
                    <span class="text-lg">${osszes} db</span>
                </div>
            `;
        }
        
        function ujKiszallitasModal() {
            const modal = document.getElementById('ujKiszallitasModal');
            const partnerSelect = document.getElementById('ujKiszallitasPartnerSelect');
            
            // Partner dropdown popul√°l√°sa
            const rendezetPartnerek = [...partnerek].sort((a, b) => a.nev.localeCompare(b.nev, 'hu'));
            partnerSelect.innerHTML = '<option value="">V√°lassz partnert...</option>' +
                rendezetPartnerek.map(p => `<option value="${p.id}">${p.nev}</option>`).join('') +
                '<option value="__UJ__">+ √öj partner...</option>';
            
            // Mai d√°tum
            ujKiszallitasMaiDatum();
            
            // Default t√≠pus: elad√°s
            document.getElementById('ujKiszallitasTipus').value = 'eladas';
            ujKiszallitasTipusValaszt('eladas');
            
            // T√∂rl√©s
            document.getElementById('ujKiszallitasMegjegyzes').value = '';
            document.getElementById('ujKiszallitasUjPartnerForm').classList.add('hidden');
            document.getElementById('ujKiszallitasUjPartnerNev').value = '';
            
            modal.classList.remove('hidden');
        }
        
        function ujKiszallitasModalBezar() {
            document.getElementById('ujKiszallitasModal').classList.add('hidden');
        }
        
        function ujKiszallitasMaiDatum() {
            const ma = new Date();
            document.getElementById('ujKiszallitasDatum').value = ma.toISOString().split('T')[0];
        }
        
        function ujKiszallitasTipusValaszt(tipus) {
            document.getElementById('ujKiszallitasTipus').value = tipus;
            
            const eladasBtn = document.getElementById('tipusEladasBtn');
            const fulfilmentBtn = document.getElementById('tipusFulfilmentBtn');
            
            if (tipus === 'eladas') {
                eladasBtn.className = 'px-6 py-4 rounded-lg font-bold text-lg border-2 border-green-500 bg-green-50 text-green-700';
                fulfilmentBtn.className = 'px-6 py-4 rounded-lg font-bold text-lg border-2 border-gray-300 bg-gray-50 text-gray-600 hover:bg-gray-100';
            } else {
                eladasBtn.className = 'px-6 py-4 rounded-lg font-bold text-lg border-2 border-gray-300 bg-gray-50 text-gray-600 hover:bg-gray-100';
                fulfilmentBtn.className = 'px-6 py-4 rounded-lg font-bold text-lg border-2 border-blue-500 bg-blue-50 text-blue-700';
            }
        }
        
        function ujKiszallitasPartnerChange() {
            const select = document.getElementById('ujKiszallitasPartnerSelect');
            const ujForm = document.getElementById('ujKiszallitasUjPartnerForm');
            
            if (select.value === '__UJ__') {
                ujForm.classList.remove('hidden');
                document.getElementById('ujKiszallitasUjPartnerNev').focus();
            } else {
                ujForm.classList.add('hidden');
            }
        }
        
        async function ujKiszallitasLetrehoz() {
            const datum = document.getElementById('ujKiszallitasDatum').value;
            const tipus = document.getElementById('ujKiszallitasTipus').value;
            const partnerSelectValue = document.getElementById('ujKiszallitasPartnerSelect').value;
            const ujPartnerNev = document.getElementById('ujKiszallitasUjPartnerNev').value.trim();
            const megjegyzes = document.getElementById('ujKiszallitasMegjegyzes').value.trim();
            
            if (!datum) {
                alert('K√©rlek v√°lassz d√°tumot!');
                return;
            }
            
            let partnerId = null;
            let partnerNev = '';
            
            // Partner kezel√©s
            if (partnerSelectValue === '__UJ__') {
                if (!ujPartnerNev) {
                    alert('Add meg az √∫j partner nev√©t!');
                    return;
                }
                
                const letezikMar = partnerek.some(p => p.nev.toLowerCase() === ujPartnerNev.toLowerCase());
                if (letezikMar) {
                    const letez≈ëPartner = partnerek.find(p => p.nev.toLowerCase() === ujPartnerNev.toLowerCase());
                    partnerId = letez≈ëPartner.id;
                    partnerNev = letez≈ëPartner.nev;
                } else {
                    partnerId = generateId();
                    partnerek.push({ id: partnerId, nev: ujPartnerNev });
                    partnerNev = ujPartnerNev;
                }
            } else if (partnerSelectValue) {
                partnerId = parseInt(partnerSelectValue);
                const partner = partnerek.find(p => p.id === partnerId);
                partnerNev = partner ? partner.nev : '';
            }
            
            // Draft l√©trehoz√°sa
            aktivDraft = {
                id: generateId(),
                datum: datum + 'T12:00:00',
                tipus,
                partnerId,
                partnerNev,
                megjegyzes,
                termekek: [],
                status: 'draft',
                created: new Date().toISOString()
            };
            
            await ment();
            ujKiszallitasModalBezar();
            
            // V√°lt√°s Kisz√°ll√≠t√°s tab-ra (NEM gy√°rt√°s!)
            switchTab('kiszallitas');
            renderDraftDoboz();
            render(); // FONTOS: + gombok megjelennek!
            
            alert('‚úÖ Kisz√°ll√≠t√°s draft l√©trehozva!\nMost add hozz√° a term√©keket a Gy√°rt√°s tab-on.');
        }
        
        function renderDraftDoboz() {
            const doboz = document.getElementById('draftDoboz');
            
            if (!aktivDraft) {
                doboz.classList.add('hidden');
                doboz.innerHTML = '';
                return;
            }
            
            const tipusIcon = aktivDraft.tipus === 'eladas' ? 'üõí' : 'üì¶';
            const tipusNev = aktivDraft.tipus === 'eladas' ? 'Elad√°s' : 'Fulfilment';
            
            // Teljes Tailwind oszt√°lynevek (nem dinamikus!)
            const bgColor = aktivDraft.tipus === 'eladas' ? 'bg-green-50' : 'bg-blue-50';
            const borderColor = aktivDraft.tipus === 'eladas' ? 'border-green-300' : 'border-blue-300';
            const titleColor = aktivDraft.tipus === 'eladas' ? 'text-green-900' : 'text-blue-900';
            const buttonBg = aktivDraft.tipus === 'eladas' ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700';
            const boldColor = aktivDraft.tipus === 'eladas' ? 'text-green-700' : 'text-blue-700';
            
            doboz.className = `${bgColor} border-2 ${borderColor} rounded-xl p-4 mb-6 relative z-10`;
            doboz.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-lg font-bold ${titleColor}">üöß AKT√çV KISZ√ÅLL√çT√ÅS (draft)</h3>
                        <div class="text-sm text-gray-700 mt-1">
                            ${aktivDraft.partnerNev || 'Partner nincs megadva'} | ${tipusIcon} ${tipusNev} | ${formatDatum(aktivDraft.datum)}
                        </div>
                        ${aktivDraft.megjegyzes ? `<div class="text-xs text-gray-600 italic mt-1">üí¨ ${aktivDraft.megjegyzes}</div>` : ''}
                    </div>
                    <button onclick="event.stopPropagation(); gyorsTermekHozzaadModal();" class="${buttonBg} text-white px-3 py-2 rounded-lg font-bold text-lg touch-manipulation" title="Term√©k hozz√°ad√°sa">
                        ‚ûï
                    </button>
                </div>
                
                <div class="bg-white rounded-lg p-3 mb-3">
                    <div class="font-semibold text-gray-700 mb-2 text-sm">Hozz√°adott term√©kek:</div>
                    ${aktivDraft.termekek.length === 0 
                        ? '<p class="text-gray-500 text-sm italic">M√©g nincs term√©k hozz√°adva. Kattints a ‚ûï gombra vagy haszn√°ld a Gy√°rt√°s tab-on a term√©kek melletti gombokat.</p>'
                        : `<div class="space-y-2">
                            ${aktivDraft.termekek.map((t, idx) => `
                                <div class="flex justify-between items-center text-sm bg-gray-50 p-2 rounded">
                                    <div class="flex-1 min-w-0 pr-2">
                                        <span class="font-medium">${t.illatNev}</span>
                                        <span class="text-gray-600"> - ${t.termekTipusNev} ${t.meret}</span>
                                        <span class="font-bold ${boldColor}"> ${t.mennyiseg} db</span>
                                    </div>
                                    <div class="flex gap-2 flex-shrink-0">
                                        <button onclick="event.stopPropagation(); draftTermekSzerkeszt(${idx});" class="text-blue-600 hover:text-blue-800 px-2 py-1 touch-manipulation text-lg">‚úèÔ∏è</button>
                                        <button onclick="event.stopPropagation(); draftTermekTorol(${idx});" class="text-red-600 hover:text-red-800 px-2 py-1 touch-manipulation text-lg">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`
                    }
                </div>
                
                <div class="flex gap-2">
                    <button onclick="event.stopPropagation(); draftVeglegesit();" class="flex-1 ${buttonBg} text-white px-4 py-3 rounded-lg font-semibold touch-manipulation">
                        ‚úÖ V√©gleges√≠t
                    </button>
                    <button onclick="event.stopPropagation(); draftElvet();" class="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 touch-manipulation">
                        üóëÔ∏è Elvet
                    </button>
                </div>
            `;
            
            doboz.classList.remove('hidden');
        }
        
        function gyorsTermekHozzaadModal() {
            if (!aktivDraft) {
                alert('Nincs akt√≠v kisz√°ll√≠t√°s!');
                return;
            }
            
            // K√©sz term√©kek csoportos√≠tva
            const csoportositott = {};
            
            keszTermekek.forEach(kt => {
                const kulcs = `${kt.illatNev}|${kt.termekTipusNev}|${kt.meret}`;
                if (!csoportositott[kulcs]) {
                    csoportositott[kulcs] = {
                        illatNev: kt.illatNev,
                        termekTipusNev: kt.termekTipusNev,
                        meret: kt.meret,
                        osszesDarab: 0
                    };
                }
                csoportositott[kulcs].osszesDarab += kt.darabszam;
            });
            
            const termekekTomb = Object.values(csoportositott).sort((a, b) => 
                a.illatNev.localeCompare(b.illatNev, 'hu')
            );
            
            if (termekekTomb.length === 0) {
                alert('Nincs k√©sz term√©k a k√©szletben!');
                return;
            }
            
            // Modal l√©trehoz√°sa
            const modal = document.createElement('div');
            modal.id = 'gyorsTermekModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-blue-900">Term√©k hozz√°ad√°sa draft-hoz</h2>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs md:text-sm">
                                <thead class="bg-emerald-100 border-b-2 border-emerald-300">
                                    <tr>
                                        <th class="text-left p-2 font-semibold text-emerald-900">Illat</th>
                                        <th class="text-left p-2 font-semibold text-emerald-900">T√≠pus / M√©ret</th>
                                        <th class="text-center p-2 font-semibold text-emerald-900">K√©szlet</th>
                                        <th class="text-center p-2 font-semibold text-emerald-900"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${termekekTomb.map((t, idx) => `
                                        <tr class="border-b border-emerald-200 hover:bg-emerald-50">
                                            <td class="p-2 font-medium text-emerald-900">${t.illatNev}</td>
                                            <td class="p-2 text-gray-700">
                                                <span class="hidden md:inline">${t.termekTipusNev} - ${t.meret}</span>
                                                <span class="md:hidden text-xs">${t.termekTipusNev.substring(0, 4)}-${t.meret.substring(0, 5)}</span>
                                            </td>
                                            <td class="p-2 text-center font-bold text-emerald-900">${t.osszesDarab} db</td>
                                            <td class="p-2 text-center">
                                                <button onclick="gyorsTermekKivalaszt('${t.illatNev}', '${t.termekTipusNev}', '${t.meret}', ${t.osszesDarab})" 
                                                    class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 font-bold text-lg">
                                                    ‚ûï
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200">
                        <button onclick="gyorsTermekModalBezar()" class="w-full px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 font-semibold">
                            Bez√°r
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function gyorsTermekModalBezar() {
            const modal = document.getElementById('gyorsTermekModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function gyorsTermekKivalaszt(illatNev, termekTipusNev, meret, maxDb) {
            // Mini modal mennyis√©g v√°laszt√°shoz
            const miniModal = document.createElement('div');
            miniModal.id = 'mennyisegModal';
            miniModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4';
            miniModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                    <h3 class="text-lg font-bold text-blue-900 mb-2">${illatNev}</h3>
                    <p class="text-sm text-gray-700 mb-1">${termekTipusNev} - ${meret}</p>
                    <p class="text-sm text-gray-600 mb-4">El√©rhet≈ë: <span class="font-bold text-emerald-700">${maxDb} db</span></p>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mennyis√©g</label>
                        <div class="flex gap-2 items-center">
                            <button onclick="mennyisegValtoztat(-1, ${maxDb})" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-xl">
                                -
                            </button>
                            <input type="number" id="mennyisegInput" value="1" min="1" max="${maxDb}" 
                                class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-center font-bold text-xl">
                            <button onclick="mennyisegValtoztat(1, ${maxDb})" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-xl">
                                +
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="mennyisegMegerosit('${illatNev}', '${termekTipusNev}', '${meret}', ${maxDb})" 
                            class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                            Hozz√°ad
                        </button>
                        <button onclick="mennyisegModalBezar()" class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            M√©gsem
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(miniModal);
            document.getElementById('mennyisegInput').focus();
        }
        
        function mennyisegValtoztat(delta, max) {
            const input = document.getElementById('mennyisegInput');
            const ujErtek = Math.max(1, Math.min(max, parseInt(input.value) + delta));
            input.value = ujErtek;
        }
        
        function mennyisegModalBezar() {
            const modal = document.getElementById('mennyisegModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function mennyisegMegerosit(illatNev, termekTipusNev, meret, maxDb) {
            const mennyiseg = parseInt(document.getElementById('mennyisegInput').value);
            
            if (mennyiseg < 1 || mennyiseg > maxDb) {
                alert(`√ârv√©nytelen mennyis√©g! (1-${maxDb})`);
                return;
            }
            
            // Ellen≈ërz√©s: m√°r szerepel-e
            const index = aktivDraft.termekek.findIndex(t => 
                t.illatNev === illatNev && 
                t.termekTipusNev === termekTipusNev && 
                t.meret === meret
            );
            
            if (index >= 0) {
                // M√°r van, n√∂velj√ºk
                aktivDraft.termekek[index].mennyiseg += mennyiseg;
            } else {
                // √öj term√©k
                aktivDraft.termekek.push({
                    illatNev,
                    termekTipusNev,
                    meret,
                    mennyiseg
                });
            }
            
            await ment();
            renderDraftDoboz();
            render();
            
            // Bez√°r√°s
            mennyisegModalBezar();
            gyorsTermekModalBezar();
            
            // Siker √ºzenet
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-[70] font-semibold';
            toast.textContent = `‚úÖ ${illatNev} hozz√°adva (${mennyiseg} db)`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        async function draftTermekHozzaad(illatNev, termekTipusNev, meret, maxDb) {
            if (!aktivDraft) {
                alert('Nincs akt√≠v kisz√°ll√≠t√°s! El≈ësz√∂r hozz l√©tre egyet a Kisz√°ll√≠t√°s tab-on.');
                return;
            }
            
            const mennyiseg = prompt(`Mennyis√©g (max: ${maxDb} db):`, '1');
            if (!mennyiseg || mennyiseg < 1 || mennyiseg > maxDb) {
                return;
            }
            
            const mennyisegInt = parseInt(mennyiseg);
            
            // Ellen≈ërz√©s: m√°r szerepel-e
            const index = aktivDraft.termekek.findIndex(t => 
                t.illatNev === illatNev && 
                t.termekTipusNev === termekTipusNev && 
                t.meret === meret
            );
            
            if (index >= 0) {
                // M√°r van, n√∂velj√ºk
                aktivDraft.termekek[index].mennyiseg += mennyisegInt;
            } else {
                // √öj term√©k
                aktivDraft.termekek.push({
                    illatNev,
                    termekTipusNev,
                    meret,
                    mennyiseg: mennyisegInt
                });
            }
            
            await ment();
            renderDraftDoboz();
            render(); // FONTOS: friss√≠ti a Gy√°rt√°s tab term√©klist√°j√°t is
        }
        
        async function draftTermekTorol(index) {
            // Vizu√°lis meger≈ës√≠t√©s mobilbar√°t modal-lal
            const termek = aktivDraft.termekek[index];
            
            const modalHTML = `
                <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-3">Biztosan t√∂rl√∂d?</h3>
                        <p class="text-gray-700 mb-4">${termek.illatNev} - ${termek.termekTipusNev} ${termek.meret} (${termek.mennyiseg} db)</p>
                        <div class="flex gap-3">
                            <button onclick="confirmDraftTermekTorol(${index})" class="flex-1 bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 font-semibold touch-manipulation">
                                T√∂rl√©s
                            </button>
                            <button onclick="closeConfirmModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-400 font-semibold touch-manipulation">
                                M√©gsem
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        async function confirmDraftTermekTorol(index) {
            aktivDraft.termekek.splice(index, 1);
            await ment();
            renderDraftDoboz();
            render();
            closeConfirmModal();
        }
        
        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            if (modal) modal.remove();
        }
        
        function draftTermekSzerkeszt(index) {
            const termek = aktivDraft.termekek[index];
            
            // Vizu√°lis szerkeszt≈ë modal
            const modalHTML = `
                <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-3">Mennyis√©g szerkeszt√©se</h3>
                        <p class="text-gray-700 mb-4">${termek.illatNev} - ${termek.termekTipusNev} ${termek.meret}</p>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">√öj mennyis√©g</label>
                            <div class="flex gap-2 items-center">
                                <button onclick="editMennyisegValtoztat(-1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-xl touch-manipulation">
                                    -
                                </button>
                                <input type="number" id="editMennyisegInput" value="${termek.mennyiseg}" min="1" 
                                    class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-center font-bold text-xl">
                                <button onclick="editMennyisegValtoztat(1)" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-xl touch-manipulation">
                                    +
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="confirmEditMennyiseg(${index})" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 font-semibold touch-manipulation">
                                Ment√©s
                            </button>
                            <button onclick="closeEditModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-400 font-semibold touch-manipulation">
                                M√©gsem
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function editMennyisegValtoztat(delta) {
            const input = document.getElementById('editMennyisegInput');
            const ujErtek = Math.max(1, parseInt(input.value) + delta);
            input.value = ujErtek;
        }
        
        function closeEditModal() {
            const modal = document.getElementById('editModal');
            if (modal) modal.remove();
        }
        
        async function confirmEditMennyiseg(index) {
            const ujMennyiseg = parseInt(document.getElementById('editMennyisegInput').value);
            if (ujMennyiseg < 1) {
                alert('A mennyis√©g legal√°bb 1 kell legyen!');
                return;
            }
            
            aktivDraft.termekek[index].mennyiseg = ujMennyiseg;
            await ment();
            renderDraftDoboz();
            render();
            closeEditModal();
        }
        
        async function draftVeglegesit() {
            if (!aktivDraft || aktivDraft.termekek.length === 0) {
                alert('Nincs term√©k a kisz√°ll√≠t√°sban!');
                return;
            }
            
            const osszDb = aktivDraft.termekek.reduce((sum, t) => sum + t.mennyiseg, 0);
            
            const megerosites = confirm(
                `V√©gleges√≠ted a kisz√°ll√≠t√°st?\n\n` +
                `${aktivDraft.partnerNev}\n` +
                `${aktivDraft.tipus === 'eladas' ? 'üõí Elad√°s' : 'üì¶ Fulfilment'}\n\n` +
                aktivDraft.termekek.map(t => `‚Ä¢ ${t.illatNev} - ${t.termekTipusNev} ${t.meret}: ${t.mennyiseg} db`).join('\n') +
                `\n\n√ñSSZESEN: ${osszDb} db`
            );
            
            if (!megerosites) return;
            
            // Kisz√°ll√≠t√°sok l√©trehoz√°sa (minden term√©kb≈ël k√ºl√∂n rekord)
            aktivDraft.termekek.forEach(termek => {
                kiszallitasok.unshift({
                    id: generateId(),
                    datum: aktivDraft.datum,
                    illatNev: termek.illatNev,
                    termekTipusNev: termek.termekTipusNev,
                    meret: termek.meret,
                    mennyiseg: termek.mennyiseg,
                    tipus: aktivDraft.tipus,
                    partnerId: aktivDraft.partnerId,
                    partnerNev: aktivDraft.partnerNev,
                    megjegyzes: aktivDraft.megjegyzes
                });
                
                // K√©szlet cs√∂kkent√©se
                const tetelek = keszTermekek.filter(kt => 
                    kt.illatNev === termek.illatNev && 
                    kt.termekTipusNev === termek.termekTipusNev && 
                    kt.meret === termek.meret
                );
                
                let maradekCsokkentes = termek.mennyiseg;
                tetelek.forEach(tetel => {
                    if (maradekCsokkentes <= 0) return;
                    
                    const csokkentes = Math.min(tetel.darabszam, maradekCsokkentes);
                    tetel.darabszam -= csokkentes;
                    maradekCsokkentes -= csokkentes;
                });
            });
            
            // 0-ra cs√∂kkent t√©telek t√∂rl√©se
            keszTermekek = keszTermekek.filter(t => t.darabszam > 0);
            
            // Draft t√∂rl√©se
            aktivDraft = null;
            
            await ment();
            render();
            renderDraftDoboz();
            
            // V√°lt√°s Kisz√°ll√≠t√°s tab-ra
            switchTab('kiszallitas');
            
            alert(`‚úÖ Kisz√°ll√≠t√°s v√©gleges√≠tve!\n${osszDb} db term√©k kisz√°ll√≠tva.`);
        }
        
        async function draftElvet() {
            // Vizu√°lis meger≈ës√≠t√©s
            const modalHTML = `
                <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-3">Biztosan elveted a draft-ot?</h3>
                        <p class="text-gray-700 mb-4">Ez NEM t√∂rli a term√©keket a k√©szletb≈ël, csak a draft kisz√°ll√≠t√°st.</p>
                        <div class="flex gap-3">
                            <button onclick="confirmDraftElvet()" class="flex-1 bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 font-semibold touch-manipulation">
                                Elvet
                            </button>
                            <button onclick="closeConfirmModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-400 font-semibold touch-manipulation">
                                M√©gsem
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        async function confirmDraftElvet() {
            aktivDraft = null;
            await ment();
            renderDraftDoboz();
            render();
            closeConfirmModal();
        }
        
        function kiszallitasSzerkeszt(id) {
            const kiszallitas = kiszallitasok.find(k => k.id === id);
            if (!kiszallitas) return;
            
            const modal = document.getElementById('kiszallitasSzerkesztModal');
            const info = document.getElementById('szerkesztKiszallitasInfo');
            const partnerSelect = document.getElementById('szerkesztPartnerSelect');
            
            // Info
            info.innerHTML = `
                <div class="font-medium mb-1">${kiszallitas.illatNev}</div>
                <div class="text-sm text-gray-600">${kiszallitas.termekTipusNev} - ${kiszallitas.meret}</div>
            `;
            
            // Partner dropdown
            const rendezetPartnerek = [...partnerek].sort((a, b) => a.nev.localeCompare(b.nev, 'hu'));
            partnerSelect.innerHTML = '<option value="">Nincs partner</option>' +
                rendezetPartnerek.map(p => 
                    `<option value="${p.id}" ${p.id === kiszallitas.partnerId ? 'selected' : ''}>${p.nev}</option>`
                ).join('');
            
            // Adatok
            document.getElementById('szerkesztKiszallitasId').value = id;
            document.getElementById('szerkesztTipus').value = kiszallitas.tipus;
            document.getElementById('szerkesztMennyiseg').value = kiszallitas.mennyiseg;
            document.getElementById('szerkesztDatum').value = kiszallitas.datum.split('T')[0];
            document.getElementById('szerkesztMegjegyzes').value = kiszallitas.megjegyzes || '';
            
            // T√≠pus gombok
            szerkesztTipusValaszt(kiszallitas.tipus);
            
            modal.classList.remove('hidden');
        }
        
        function kiszallitasSzerkesztModalBezar() {
            document.getElementById('kiszallitasSzerkesztModal').classList.add('hidden');
        }
        
        function szerkesztTipusValaszt(tipus) {
            document.getElementById('szerkesztTipus').value = tipus;
            
            const eladasBtn = document.getElementById('szerkesztTipusEladasBtn');
            const fulfilmentBtn = document.getElementById('szerkesztTipusFulfilmentBtn');
            
            if (tipus === 'eladas') {
                eladasBtn.className = 'px-6 py-3 rounded-lg font-bold border-2 border-green-500 bg-green-50 text-green-700';
                fulfilmentBtn.className = 'px-6 py-3 rounded-lg font-bold border-2 border-gray-300 bg-gray-50 text-gray-600 hover:bg-gray-100';
            } else {
                eladasBtn.className = 'px-6 py-3 rounded-lg font-bold border-2 border-gray-300 bg-gray-50 text-gray-600 hover:bg-gray-100';
                fulfilmentBtn.className = 'px-6 py-3 rounded-lg font-bold border-2 border-blue-500 bg-blue-50 text-blue-700';
            }
        }
        
        function szerkesztMennyisegValtoztat(valtozas) {
            const input = document.getElementById('szerkesztMennyiseg');
            const jelenlegiErtek = parseInt(input.value) || 0;
            const ujErtek = Math.max(1, jelenlegiErtek + valtozas);
            input.value = ujErtek;
        }
        
        async function kiszallitasSzerkesztMent() {
            const id = parseInt(document.getElementById('szerkesztKiszallitasId').value);
            const kiszallitas = kiszallitasok.find(k => k.id === id);
            if (!kiszallitas) return;
            
            const ujTipus = document.getElementById('szerkesztTipus').value;
            const ujPartnerId = document.getElementById('szerkesztPartnerSelect').value;
            const ujMennyiseg = parseInt(document.getElementById('szerkesztMennyiseg').value);
            const ujDatum = document.getElementById('szerkesztDatum').value;
            const ujMegjegyzes = document.getElementById('szerkesztMegjegyzes').value.trim();
            
            // Partner n√©v
            let ujPartnerNev = '';
            if (ujPartnerId) {
                const partner = partnerek.find(p => p.id === parseInt(ujPartnerId));
                ujPartnerNev = partner ? partner.nev : '';
            }
            
            // M√≥dos√≠t√°s
            kiszallitas.tipus = ujTipus;
            kiszallitas.partnerId = ujPartnerId ? parseInt(ujPartnerId) : null;
            kiszallitas.partnerNev = ujPartnerNev;
            kiszallitas.mennyiseg = ujMennyiseg;
            kiszallitas.datum = ujDatum + 'T12:00:00';
            kiszallitas.megjegyzes = ujMegjegyzes;
            
            await ment();
            renderKiszallitasok();
            kiszallitasSzerkesztModalBezar();
            
            alert('‚úÖ Kisz√°ll√≠t√°s m√≥dos√≠tva!');
        }

        function switchTab(tabName) {
            akt√≠vTab = tabName;
            
            // Tab gombok friss√≠t√©se - mobilbar√°t oszt√°lyokkal
            document.getElementById('gyartasTabBtn').className = tabName === 'gyartas' 
                ? 'flex-1 px-3 md:px-6 py-3 md:py-4 text-center font-semibold transition border-b-2 border-amber-600 text-amber-900 text-sm md:text-base'
                : 'flex-1 px-3 md:px-6 py-3 md:py-4 text-center font-semibold transition border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm md:text-base';
            
            document.getElementById('kiszallitasTabBtn').className = tabName === 'kiszallitas' 
                ? 'flex-1 px-3 md:px-6 py-3 md:py-4 text-center font-semibold transition border-b-2 border-blue-600 text-blue-900 text-sm md:text-base'
                : 'flex-1 px-3 md:px-6 py-3 md:py-4 text-center font-semibold transition border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm md:text-base';
            
            // Tab tartalmak v√°lt√°sa
            document.getElementById('gyartasTab').classList.toggle('hidden', tabName !== 'gyartas');
            document.getElementById('kiszallitasTab').classList.toggle('hidden', tabName !== 'kiszallitas');
            
            // Ha kisz√°ll√≠t√°s tab, renderelj√ºk a draft-ot √©s statisztik√°t
            if (tabName === 'kiszallitas') {
                renderDraftDoboz();
                renderStatisztika();
                renderKiszallitasok();
            }
        }

        let kiszallitasData = null; // Modal adatok

        function kiszallitasModal(illatNev, termekTipusNev, meret, osszesDarab) {
            kiszallitasData = { illatNev, termekTipusNev, meret, osszesDarab };
            
            const modal = document.getElementById('kiszallitasModal');
            const info = document.getElementById('kiszallitasTermekInfo');
            const mennyisegInput = document.getElementById('kiszallitasMennyiseg');
            const partnerSelect = document.getElementById('kiszallitasPartnerSelect');
            
            info.innerHTML = `
                <div class="font-medium mb-1">${illatNev}</div>
                <div class="text-sm text-gray-600">${termekTipusNev} - ${meret}</div>
                <div class="text-sm text-gray-600 mt-2">El√©rhet≈ë: <span class="font-bold text-blue-700">${osszesDarab} db</span></div>
            `;
            
            // Partner select popul√°l√°sa
            const rendezetPartnerek = [...partnerek].sort((a, b) => a.nev.localeCompare(b.nev, 'hu'));
            partnerSelect.innerHTML = '<option value="">V√°lassz partnert...</option>' +
                rendezetPartnerek.map(p => `<option value="${p.id}">${p.nev}</option>`).join('') +
                '<option value="__UJ__">+ √öj partner...</option>';
            
            mennyisegInput.value = 1;
            mennyisegInput.max = osszesDarab;
            document.getElementById('kiszallitasMegjegyzes').value = '';
            document.getElementById('kiszallitasTipus').value = 'eladas';
            document.getElementById('ujPartnerForm').classList.add('hidden');
            document.getElementById('ujPartnerNev').value = '';
            
            // Mai d√°tum be√°ll√≠t√°sa
            kiszallitasMaiDatum();
            
            modal.classList.remove('hidden');
        }

        function kiszallitasMaiDatum() {
            const ma = new Date();
            const dateString = ma.toISOString().split('T')[0];
            document.getElementById('kiszallitasDatum').value = dateString;
        }

        function kiszallitasPartnerChange() {
            const select = document.getElementById('kiszallitasPartnerSelect');
            const ujForm = document.getElementById('ujPartnerForm');
            
            if (select.value === '__UJ__') {
                ujForm.classList.remove('hidden');
                document.getElementById('ujPartnerNev').focus();
            } else {
                ujForm.classList.add('hidden');
                document.getElementById('ujPartnerNev').value = '';
            }
        }

        function kiszallitasMennyisegValtoztat(valtozas) {
            if (!kiszallitasData) return;
            const input = document.getElementById('kiszallitasMennyiseg');
            const jelenlegiErtek = parseInt(input.value) || 0;
            const ujErtek = Math.max(1, Math.min(kiszallitasData.osszesDarab, jelenlegiErtek + valtozas));
            input.value = ujErtek;
        }

        function kiszallitasModalBezar() {
            document.getElementById('kiszallitasModal').classList.add('hidden');
            kiszallitasData = null;
        }

        async function kiszallitasRogzit() {
            if (!kiszallitasData) return;
            
            const mennyiseg = parseInt(document.getElementById('kiszallitasMennyiseg').value);
            const tipus = document.getElementById('kiszallitasTipus').value;
            const datum = document.getElementById('kiszallitasDatum').value;
            const megjegyzes = document.getElementById('kiszallitasMegjegyzes').value.trim();
            const partnerSelectValue = document.getElementById('kiszallitasPartnerSelect').value;
            const ujPartnerNev = document.getElementById('ujPartnerNev').value.trim();
            
            if (!mennyiseg || mennyiseg < 1 || mennyiseg > kiszallitasData.osszesDarab) {
                alert('√ârv√©nytelen mennyis√©g!');
                return;
            }
            
            if (!datum) {
                alert('K√©rlek v√°lassz d√°tumot!');
                return;
            }
            
            let partnerNev = '';
            let partnerId = null;
            
            // Partner kezel√©s
            if (partnerSelectValue === '__UJ__') {
                // √öj partner
                if (!ujPartnerNev) {
                    alert('Add meg az √∫j partner nev√©t!');
                    return;
                }
                
                // Ellen≈ërz√©s: m√°r l√©tezik-e
                const letezikMar = partnerek.some(p => p.nev.toLowerCase() === ujPartnerNev.toLowerCase());
                if (letezikMar) {
                    const letez≈ëPartner = partnerek.find(p => p.nev.toLowerCase() === ujPartnerNev.toLowerCase());
                    partnerId = letez≈ëPartner.id;
                    partnerNev = letez≈ëPartner.nev;
                } else {
                    // √öj partner hozz√°ad√°sa
                    partnerId = generateId();
                    partnerek.push({ id: partnerId, nev: ujPartnerNev });
                    partnerNev = ujPartnerNev;
                }
            } else if (partnerSelectValue) {
                // Megl√©v≈ë partner
                partnerId = parseInt(partnerSelectValue);
                const partner = partnerek.find(p => p.id === partnerId);
                partnerNev = partner ? partner.nev : '';
            }
            
            const { illatNev, termekTipusNev, meret, osszesDarab } = kiszallitasData;
            
            // D√°tum ISO form√°tumra konvert√°l√°s (helyi id≈ëvel)
            const datumISO = new Date(datum + 'T12:00:00').toISOString();
            
            // √öj kisz√°ll√≠t√°s r√∂gz√≠t√©se
            const ujKiszallitas = {
                id: generateId(),
                datum: datumISO,
                illatNev,
                termekTipusNev,
                meret,
                mennyiseg,
                tipus,
                partnerId,
                partnerNev,
                megjegyzes
            };
            
            kiszallitasok.unshift(ujKiszallitas);
            
            // K√©szlet cs√∂kkent√©se
            const tetelek = keszTermekek.filter(t => 
                t.illatNev === illatNev && 
                t.termekTipusNev === termekTipusNev && 
                t.meret === meret
            );
            
            let maradekCsokkentes = mennyiseg;
            tetelek.forEach(tetel => {
                if (maradekCsokkentes <= 0) return;
                
                const csokkentes = Math.min(tetel.darabszam, maradekCsokkentes);
                tetel.darabszam -= csokkentes;
                maradekCsokkentes -= csokkentes;
            });
            
            keszTermekek = keszTermekek.filter(t => t.darabszam > 0);
            
            await ment();
            render();
            renderKiszallitasok();
            kiszallitasModalBezar();
            
            alert(`‚úÖ Kisz√°ll√≠t√°s r√∂gz√≠tve!\n${mennyiseg} db - ${illatNev}`);
        }

        function szurokTorlese() {
            document.getElementById('szuroTipus').value = '';
            document.getElementById('szuroPartner').value = '';
            document.getElementById('szuroTermek').value = '';
            document.getElementById('szuroDatumTol').value = '';
            document.getElementById('szuroDatumIg').value = '';
            renderKiszallitasok();
        }

        function renderKiszallitasok() {
            const lista = document.getElementById('kiszallitasokLista');
            const osszesito = document.getElementById('kiszallitasOsszesito');
            
            // Sz≈±r≈ëk √©rt√©kei
            const szuroTipus = document.getElementById('szuroTipus').value;
            const szuroPartner = document.getElementById('szuroPartner').value;
            const szuroTermek = document.getElementById('szuroTermek').value;
            const szuroDatumTol = document.getElementById('szuroDatumTol').value;
            const szuroDatumIg = document.getElementById('szuroDatumIg').value;
            
            // Partner √©s term√©k sz≈±r≈ëk popul√°l√°sa
            const partnerSzuroSelect = document.getElementById('szuroPartner');
            const termekSzuroSelect = document.getElementById('szuroTermek');
            
            // Egyedi partnerek a kisz√°ll√≠t√°sokb√≥l
            const egyediPartnerek = [...new Set(kiszallitasok.map(k => k.partnerNev).filter(Boolean))].sort();
            const jelenlegiPartnerErtek = partnerSzuroSelect.value;
            partnerSzuroSelect.innerHTML = '<option value="">√ñsszes</option>' +
                egyediPartnerek.map(p => `<option value="${p}" ${p === jelenlegiPartnerErtek ? 'selected' : ''}>${p}</option>`).join('');
            
            // Egyedi term√©kek (illatok) a kisz√°ll√≠t√°sokb√≥l
            const egyediTermekek = [...new Set(kiszallitasok.map(k => k.illatNev))].sort((a, b) => a.localeCompare(b, 'hu'));
            const jelenlegiTermekErtek = termekSzuroSelect.value;
            termekSzuroSelect.innerHTML = '<option value="">√ñsszes</option>' +
                egyediTermekek.map(t => `<option value="${t}" ${t === jelenlegiTermekErtek ? 'selected' : ''}>${t}</option>`).join('');
            
            // Sz≈±r√©s
            let szurtKiszallitasok = kiszallitasok.filter(k => {
                // T√≠pus sz≈±r≈ë
                if (szuroTipus && k.tipus !== szuroTipus) return false;
                
                // Partner sz≈±r≈ë
                if (szuroPartner && k.partnerNev !== szuroPartner) return false;
                
                // Term√©k sz≈±r≈ë
                if (szuroTermek && k.illatNev !== szuroTermek) return false;
                
                // D√°tum sz≈±r≈ë
                const kiszallitasDatum = new Date(k.datum);
                if (szuroDatumTol) {
                    const tolDatum = new Date(szuroDatumTol);
                    if (kiszallitasDatum < tolDatum) return false;
                }
                if (szuroDatumIg) {
                    const igDatum = new Date(szuroDatumIg + 'T23:59:59');
                    if (kiszallitasDatum > igDatum) return false;
                }
                
                return true;
            });
            
            if (szurtKiszallitasok.length === 0) {
                lista.innerHTML = '<p class="text-gray-500 text-center py-8">Nincs a sz≈±r√©snek megfelel≈ë kisz√°ll√≠t√°s</p>';
                osszesito.innerHTML = '';
                return;
            }
            
            // √ñsszes√≠t≈ë sz√°m√≠t√°sok
            const maiKiszallitas = szurtKiszallitasok.filter(k => {
                const kiszallitasDatum = new Date(k.datum);
                const ma = new Date();
                return kiszallitasDatum.toDateString() === ma.toDateString();
            }).reduce((sum, k) => sum + k.mennyiseg, 0);
            
            const hetiKiszallitas = szurtKiszallitasok.filter(k => {
                const kiszallitasDatum = new Date(k.datum);
                const ma = new Date();
                const hetElodje = new Date(ma.getTime() - 7 * 24 * 60 * 60 * 1000);
                return kiszallitasDatum >= hetElodje;
            }).reduce((sum, k) => sum + k.mennyiseg, 0);
            
            const osszesKiszallitas = szurtKiszallitasok.reduce((sum, k) => sum + k.mennyiseg, 0);
            
            osszesito.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                    <div class="text-sm text-gray-600 mb-1">Mai kisz√°ll√≠t√°s</div>
                    <div class="text-2xl font-bold text-blue-700">${maiKiszallitas} db</div>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg border-2 border-indigo-200">
                    <div class="text-sm text-gray-600 mb-1">Heti kisz√°ll√≠t√°s</div>
                    <div class="text-2xl font-bold text-indigo-700">${hetiKiszallitas} db</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200">
                    <div class="text-sm text-gray-600 mb-1">Sz≈±rt √∂sszesen</div>
                    <div class="text-2xl font-bold text-purple-700">${osszesKiszallitas} db</div>
                </div>
            `;
            
            // Lista renderel√©s - CSOPORTOS√çTOTT FORM√ÅTUM
            // Csoportos√≠t√°s d√°tum + partner + t√≠pus szerint
            const csoportok = {};
            szurtKiszallitasok.forEach(k => {
                const kulcs = `${k.datum.split('T')[0]}_${k.tipus}_${k.partnerNev || 'nincs'}`;
                if (!csoportok[kulcs]) {
                    csoportok[kulcs] = {
                        datum: k.datum,
                        tipus: k.tipus,
                        partnerNev: k.partnerNev,
                        termekek: [],
                        osszesDb: 0,
                        megjegyzes: k.megjegyzes
                    };
                }
                csoportok[kulcs].termekek.push({
                    id: k.id,
                    illatNev: k.illatNev,
                    termekTipusNev: k.termekTipusNev,
                    meret: k.meret,
                    mennyiseg: k.mennyiseg
                });
                csoportok[kulcs].osszesDb += k.mennyiseg;
            });
            
            const csoportokTomb = Object.values(csoportok).sort((a, b) => 
                new Date(b.datum) - new Date(a.datum)
            );
            
            if (csoportokTomb.length === 0) {
                lista.innerHTML = '<p class="text-gray-500 text-center py-8">Nincs kisz√°ll√≠t√°s</p>';
                return;
            }
            
            lista.innerHTML = `
                <div class="space-y-3">
                    ${csoportokTomb.map((csoport, idx) => {
                        const tipusIcon = csoport.tipus === 'eladas' ? 'üõí' : 'üì¶';
                        const tipusNev = csoport.tipus === 'eladas' ? 'Elad√°s' : 'Fulfilment';
                        
                        // Teljes Tailwind oszt√°lynevek
                        const borderColor = csoport.tipus === 'eladas' ? 'border-green-200' : 'border-blue-200';
                        const bgColor = csoport.tipus === 'eladas' ? 'bg-green-50' : 'bg-blue-50';
                        const hoverBg = csoport.tipus === 'eladas' ? 'hover:bg-green-100' : 'hover:bg-blue-100';
                        const titleColor = csoport.tipus === 'eladas' ? 'text-green-900' : 'text-blue-900';
                        const boldColor = csoport.tipus === 'eladas' ? 'text-green-700' : 'text-blue-700';
                        const theadBg = csoport.tipus === 'eladas' ? 'bg-green-100' : 'bg-blue-100';
                        const borderThin = csoport.tipus === 'eladas' ? 'border-green-100' : 'border-blue-100';
                        
                        return `
                            <div class="border-2 ${borderColor} rounded-lg ${bgColor} overflow-hidden">
                                <!-- √ñsszefoglal√≥ (mindig l√°tszik) -->
                                <div class="p-3 md:p-4 cursor-pointer ${hoverBg}" onclick="toggleKiszallitasCsoport(${idx})">
                                    <div class="flex justify-between items-center">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-lg">${tipusIcon}</span>
                                                <span class="font-bold ${titleColor}">${tipusNev}</span>
                                                <span class="text-sm text-gray-600">${formatDatum(csoport.datum)}</span>
                                            </div>
                                            ${csoport.partnerNev ? `<div class="text-sm text-gray-700">üë§ ${csoport.partnerNev}</div>` : ''}
                                            ${csoport.megjegyzes ? `<div class="text-xs text-gray-600 italic mt-1">üí¨ ${csoport.megjegyzes}</div>` : ''}
                                        </div>
                                        <div class="text-right">
                                            <div class="text-2xl font-bold ${boldColor}">${csoport.osszesDb} db</div>
                                            <div class="text-xs text-gray-600">${csoport.termekek.length} t√©tel</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- R√©szletek (kibonthat√≥) -->
                                <div id="kiszallitasCsoport${idx}" class="hidden border-t-2 ${borderColor} bg-white">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-xs md:text-sm">
                                            <thead class="${theadBg}">
                                                <tr>
                                                    <th class="text-left p-2 font-semibold ${titleColor}">Term√©k</th>
                                                    <th class="text-center p-2 font-semibold ${titleColor}">Db</th>
                                                    <th class="text-center p-2 font-semibold ${titleColor}"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${csoport.termekek.map(t => `
                                                    <tr class="border-b ${borderThin}">
                                                        <td class="p-2">
                                                            <div class="font-medium">${t.illatNev}</div>
                                                            <div class="text-xs text-gray-600">${t.termekTipusNev} - ${t.meret}</div>
                                                        </td>
                                                        <td class="p-2 text-center font-bold ${boldColor}">${t.mennyiseg} db</td>
                                                        <td class="p-2 text-center">
                                                            <div class="flex gap-1 justify-center">
                                                                <button onclick="event.stopPropagation(); kiszallitasSzerkeszt(${t.id})" class="text-blue-600 hover:text-blue-800 px-1" title="Szerkeszt√©s">
                                                                    ‚úèÔ∏è
                                                                </button>
                                                                <button onclick="event.stopPropagation(); kiszallitasTorol(${t.id})" class="text-red-600 hover:text-red-800 px-1" title="T√∂rl√©s">
                                                                    üóëÔ∏è
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function toggleKiszallitasCsoport(index) {
            const elem = document.getElementById(`kiszallitasCsoport${index}`);
            elem.classList.toggle('hidden');
        }

        async function kiszallitasTorol(id) {
            if (!confirm('Biztosan t√∂rl√∂d ezt a kisz√°ll√≠t√°st?\n\nFigyelem: Ez NEM √°ll√≠tja vissza a k√©szletet!')) {
                return;
            }
            
            kiszallitasok = kiszallitasok.filter(k => k.id !== id);
            await ment();
            renderKiszallitasok();
        }

        function scrollToProductForm() {
            const formElement = document.getElementById('kiontesForm');
            if (formElement) {
                formElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function keszTermekRendezesValtozas() {
            keszTermekRendezes = document.getElementById('keszTermekRendezes').value;
            render();
        }

        // Firebase ment√©s
        async function ment() {
            try {
                // Minden adat ment√©se Firebase-be
                await Promise.all([
                    window.firestore.setDoc(window.firestore.doc(window.db, 'appData', 'illatok'), { data: illatok }),
                    window.firestore.setDoc(window.firestore.doc(window.db, 'appData', 'kiontesek'), { data: kiontesek }),
                    window.firestore.setDoc(window.firestore.doc(window.db, 'appData', 'meretek'), { data: meretek }),
                    window.firestore.setDoc(window.firestore.doc(window.db, 'appData', 'cimkeKeszlet'), { data: cimkeKeszlet }),
                    window.firestore.setDoc(window.firestore.doc(window.db, 'appData', 'keszTermekek'), { data: keszTermekek }),
                    window.firestore.setDoc(window.firestore.doc(window.db, 'appData', 'kiszallitasok'), { data: kiszallitasok }),
                    window.firestore.setDoc(window.firestore.doc(window.db, 'appData', 'partnerek'), { data: partnerek }),
                    window.firestore.setDoc(window.firestore.doc(window.db, 'appData', 'aktivDraft'), { data: aktivDraft })
                ]);
            } catch (error) {
                console.error('Ment√©si hiba:', error);
                alert('Hiba t√∂rt√©nt az adatok ment√©se k√∂zben!');
            }
        }

        function toggleBeallitasok() {
            const modal = document.getElementById('beallitasokModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                renderBeallitasok();
            }
        }

        function renderBeallitasok() {
            // Gyertya m√©retek
            const gyertyaLista = document.getElementById('gyertyaMeretLista');
            if (gyertyaLista) {
                gyertyaLista.innerHTML = '';
                meretek.gyertya.forEach((m, idx) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 bg-amber-50 rounded';
                    
                    const span = document.createElement('span');
                    span.textContent = m;
                    
                    const button = document.createElement('button');
                    button.textContent = 'T√∂rl√©s';
                    button.className = 'text-red-600 hover:text-red-800 text-sm';
                    button.onclick = () => meretTorol('gyertya', idx);
                    
                    div.appendChild(span);
                    div.appendChild(button);
                    gyertyaLista.appendChild(div);
                });
            }

            // Spray m√©retek
            const sprayLista = document.getElementById('sprayMeretLista');
            if (sprayLista) {
                sprayLista.innerHTML = '';
                meretek.spray.forEach((m, idx) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 bg-blue-50 rounded';
                    
                    const span = document.createElement('span');
                    span.textContent = m;
                    
                    const button = document.createElement('button');
                    button.textContent = 'T√∂rl√©s';
                    button.className = 'text-red-600 hover:text-red-800 text-sm';
                    button.onclick = () => meretTorol('spray', idx);
                    
                    div.appendChild(span);
                    div.appendChild(button);
                    sprayLista.appendChild(div);
                });
            }

            // Diffuser m√©retek
            const diffuserLista = document.getElementById('diffuserMeretLista');
            if (diffuserLista) {
                diffuserLista.innerHTML = '';
                meretek.diffuser.forEach((m, idx) => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 bg-green-50 rounded';
                    
                    const span = document.createElement('span');
                    span.textContent = m;
                    
                    const button = document.createElement('button');
                    button.textContent = 'T√∂rl√©s';
                    button.className = 'text-red-600 hover:text-red-800 text-sm';
                    button.onclick = () => meretTorol('diffuser', idx);
                    
                    div.appendChild(span);
                    div.appendChild(button);
                    diffuserLista.appendChild(div);
                });
            }
        }

        function meretHozzaad(tipus) {
            const inputId = `uj${tipus.charAt(0).toUpperCase() + tipus.slice(1)}Meret`;
            const input = document.getElementById(inputId);
            const ujMeret = input.value.trim();
            
            if (ujMeret) {
                meretek[tipus].push(ujMeret);
                input.value = '';
                ment();
                renderBeallitasok();
                render(); // Friss√≠tj√ºk a f≈ë n√©zetet is
            }
        }

        function meretTorol(tipus, index) {
            if (confirm('Biztosan t√∂rl√∂d ezt a m√©retet?')) {
                meretek[tipus].splice(index, 1);
                ment();
                renderBeallitasok();
                render(); // Friss√≠tj√ºk a f≈ë n√©zetet is
            }
        }

        function updateNyomtatasMeretOptions() {
            const termekTipus = document.getElementById('nyomtatasTermekTipus').value;
            const meretSelect = document.getElementById('nyomtatasMeret');
            
            if (termekTipus && meretek[termekTipus]) {
                meretSelect.innerHTML = '<option value="">V√°lassz m√©retet...</option>' +
                    meretek[termekTipus].map(m => `<option value="${m}">${m}</option>`).join('');
            } else {
                meretSelect.innerHTML = '<option value="">El≈ësz√∂r v√°lassz term√©k t√≠pust</option>';
            }
        }

        function getCimkeKulcs(illatId, termekTipus, meret) {
            return `${illatId}-${termekTipus}-${meret}`;
        }

        function gyorsNyomtatas(illatId, termekTipus, meret) {
            const inputId = `lapok-${illatId}-${termekTipus}-${meret}`;
            const lapokInput = document.getElementById(inputId);
            const lapok = parseInt(lapokInput.value);
            
            if (!lapok || lapok < 1) {
                alert('K√©rlek adj meg egy √©rv√©nyes lap sz√°mot!');
                return;
            }
            
            const kulcs = getCimkeKulcs(illatId, termekTipus, meret);
            const cimkeDarab = lapok * 12;
            
            if (!cimkeKeszlet[kulcs]) {
                cimkeKeszlet[kulcs] = 0;
            }
            cimkeKeszlet[kulcs] += cimkeDarab;
            
            ment();
            render();
            
            alert(`${cimkeDarab} db c√≠mke (${lapok} lap) hozz√°adva a k√©szlethez!`);
        }

        function cimkeNyomtatasRogzit() {
            const termekTipus = document.getElementById('nyomtatasTermekTipus').value;
            const meret = document.getElementById('nyomtatasMeret').value;
            const illatId = parseInt(document.getElementById('nyomtatasIllat').value);
            const lapok = parseInt(document.getElementById('nyomtatottLapok').value);
            
            if (termekTipus && meret && illatId && lapok > 0) {
                const kulcs = getCimkeKulcs(illatId, termekTipus, meret);
                const cimkeDarab = lapok * 12;
                
                if (!cimkeKeszlet[kulcs]) {
                    cimkeKeszlet[kulcs] = 0;
                }
                cimkeKeszlet[kulcs] += cimkeDarab;
                
                document.getElementById('nyomtatasTermekTipus').value = '';
                document.getElementById('nyomtatasMeret').innerHTML = '<option value="">El≈ësz√∂r v√°lassz term√©k t√≠pust</option>';
                document.getElementById('nyomtatasIllat').value = '';
                document.getElementById('nyomtatottLapok').value = '';
                
                ment();
                render();
                
                alert(`${cimkeDarab} db c√≠mke hozz√°adva a k√©szlethez!`);
            } else {
                alert('K√©rlek t√∂ltsd ki az √∂sszes mez≈ët!');
            }
        }

        function cimkeKeszletSzerkeszt(kulcs, illatNev, termekTipusNev, meret) {
            const jelenlegiMennyiseg = cimkeKeszlet[kulcs] || 0;
            const ujMennyiseg = prompt(`C√≠mke k√©szlet szerkeszt√©se\n\n${illatNev} - ${termekTipusNev} - ${meret}\n\nJelenlegi mennyis√©g: ${jelenlegiMennyiseg} db\n\n√öj mennyis√©g:`, jelenlegiMennyiseg);
            
            if (ujMennyiseg !== null) {
                const szam = parseInt(ujMennyiseg);
                if (!isNaN(szam) && szam >= 0) {
                    cimkeKeszlet[kulcs] = szam;
                    ment();
                    render();
                } else {
                    alert('K√©rlek adj meg egy √©rv√©nyes sz√°mot!');
                }
            }
        }

        function csoportCimkezTeljes(kulcs, osszesDarab) {
            // Megkeress√ºk az √∂sszes t√©telt ebb≈ël a csoportb√≥l
            const [illatId, termekTipus, meret] = kulcs.split('-');
            const csoportTetelek = kiontesek.filter(k => 
                k.illatId === parseInt(illatId) && 
                k.termekTipus === termekTipus && 
                k.meret === meret
            );
            
            if (csoportTetelek.length === 0) return;
            
            const keszletMennyiseg = cimkeKeszlet[kulcs] || 0;
            
            if (keszletMennyiseg < osszesDarab) {
                alert(`Nincs el√©g c√≠mke a k√©szletben!\n\nSz√ºks√©ges: ${osszesDarab} db\nK√©szlet: ${keszletMennyiseg} db\n\nHaszn√°ld a "R√©szleges" gombot!`);
                return;
            }
            
            // Modal megnyit√°sa az els≈ë t√©tellel (reprezentat√≠v)
            const elsoTetel = csoportTetelek[0];
            const osszesitettTetel = {
                ...elsoTetel,
                darabszam: osszesDarab,
                id: 'csoport-' + kulcs
            };
            teljesCimkezesModal('csoport', osszesitettTetel);
        }

        function csoportCimkezReszleges(kulcs, osszesDarab, keszletMennyiseg) {
            const maxCimkezheto = Math.min(keszletMennyiseg, osszesDarab);
            
            if (maxCimkezheto === 0) {
                alert('Nincs c√≠mke a k√©szletben!');
                return;
            }
            
            // Megkeress√ºk az els≈ë t√©telt reprezent√°ci√≥k√©nt
            const [illatId, termekTipus, meret] = kulcs.split('-');
            const csoportTetelek = kiontesek.filter(k => 
                k.illatId === parseInt(illatId) && 
                k.termekTipus === termekTipus && 
                k.meret === meret
            );
            
            if (csoportTetelek.length === 0) return;
            
            const elsoTetel = csoportTetelek[0];
            const osszesitettTetel = {
                ...elsoTetel,
                darabszam: osszesDarab,
                id: 'csoport-' + kulcs
            };
            
            reszlegesCimkezesModal('csoport', osszesitettTetel, maxCimkezheto, keszletMennyiseg);
        }

        function csoportTorolCimkezetlen(kulcs) {
            const [illatId, termekTipus, meret] = kulcs.split('-');
            const csoportTetelek = kiontesek.filter(k => 
                k.illatId === parseInt(illatId) && 
                k.termekTipus === termekTipus && 
                k.meret === meret
            );
            
            if (csoportTetelek.length === 0) return;
            
            const osszesDarab = csoportTetelek.reduce((sum, k) => sum + k.darabszam, 0);
            
            if (confirm(`Biztosan t√∂rl√∂d az √∂sszes t√©telt ebb≈ël?\n\n${csoportTetelek[0].illatNev} - ${csoportTetelek[0].termekTipusNev} - ${csoportTetelek[0].meret}\n\n√ñsszesen: ${osszesDarab} db (${csoportTetelek.length} t√©tel)`)) {
                // T√∂rl√©s
                kiontesek = kiontesek.filter(k => 
                    !(k.illatId === parseInt(illatId) && 
                      k.termekTipus === termekTipus && 
                      k.meret === meret)
                );
                ment();
                render();
            }
        }

        let teljesCimkezesData = null; // T√°rol√°s a modal sz√°m√°ra

        function termekCimkezTeljes(kiontesId) {
            const kiontes = kiontesek.find(k => k.id === kiontesId);
            if (!kiontes) return;
            
            const kulcs = getCimkeKulcs(kiontes.illatId, kiontes.termekTipus, kiontes.meret);
            const keszletMennyiseg = cimkeKeszlet[kulcs] || 0;
            
            if (keszletMennyiseg < kiontes.darabszam) {
                alert(`Nincs el√©g c√≠mke a k√©szletben!\n\nSz√ºks√©ges: ${kiontes.darabszam} db\nK√©szlet: ${keszletMennyiseg} db\n\nHaszn√°ld a "R√©szleges" gombot!`);
                return;
            }
            
            // Modal megnyit√°sa
            teljesCimkezesModal(kiontesId, kiontes);
        }

        function teljesCimkezesModal(kiontesId, kiontes = null) {
            const modal = document.getElementById('teljesCimkezesModal');
            
            if (kiontesId === null || kiontes === null) {
                // Bez√°r√°s
                modal.classList.add('hidden');
                teljesCimkezesData = null;
                return;
            }
            
            // Adatok t√°rol√°sa
            teljesCimkezesData = { kiontesId, kiontes };
            
            // Info kit√∂lt√©se
            const info = document.getElementById('teljesCimkezesInfo');
            info.innerHTML = `
                <div class="text-center">
                    <div class="text-lg font-bold mb-2">${kiontes.illatNev}</div>
                    <div class="text-sm text-gray-600 mb-1">${kiontes.termekTipusNev} - ${kiontes.meret}</div>
                    <div class="text-3xl font-bold text-green-700 mt-3">${kiontes.darabszam} db</div>
                    <div class="text-sm text-gray-600 mt-1">√∂sszes term√©ket c√≠mk√©zed</div>
                </div>
            `;
            
            // Modal megnyit√°sa
            modal.classList.remove('hidden');
        }

        function teljesCimkezesVegrehajt() {
            if (!teljesCimkezesData) return;
            
            const { kiontesId, kiontes } = teljesCimkezesData;
            
            // Csoportos c√≠mk√©z√©s eset√©n
            if (typeof kiontesId === 'string' && kiontesId.startsWith('csoport')) {
                const kulcs = getCimkeKulcs(kiontes.illatId, kiontes.termekTipus, kiontes.meret);
                
                // Megkeress√ºk az √∂sszes t√©telt
                const csoportTetelek = kiontesek.filter(k => 
                    k.illatId === kiontes.illatId && 
                    k.termekTipus === kiontes.termekTipus && 
                    k.meret === kiontes.meret
                );
                
                // Levon√°s a c√≠mke k√©szletb≈ël
                cimkeKeszlet[kulcs] -= kiontes.darabszam;
                
                // Minden t√©tel √°tker√ºl a k√©sz term√©kek k√∂z√©
                csoportTetelek.forEach(tetel => {
                    keszTermekek.unshift({
                        ...tetel,
                        cimkezveIdopont: new Date().toISOString()
                    });
                });
                
                // T√∂rl√©s a ki√∂nt√©sek k√∂z√ºl
                kiontesek = kiontesek.filter(k => 
                    !(k.illatId === kiontes.illatId && 
                      k.termekTipus === kiontes.termekTipus && 
                      k.meret === kiontes.meret)
                );
            } else {
                // Egyedi t√©tel c√≠mk√©z√©se
                const kulcs = getCimkeKulcs(kiontes.illatId, kiontes.termekTipus, kiontes.meret);
                
                cimkeKeszlet[kulcs] -= kiontes.darabszam;
                
                const ujTermek = {
                    ...kiontes,
                    cimkezveIdopont: new Date().toISOString()
                };
                keszTermekek.unshift(ujTermek);
                
                kiontesek = kiontesek.filter(k => k.id !== kiontesId);
            }
            
            ment();
            render();
            
            // Modal bez√°r√°sa
            teljesCimkezesModal(null);
        }

        let reszlegesCimkezesData = null; // T√°rol√°s a modal sz√°m√°ra

        function termekCimkezReszleges(kiontesId) {
            const kiontes = kiontesek.find(k => k.id === kiontesId);
            if (!kiontes) return;
            
            const kulcs = getCimkeKulcs(kiontes.illatId, kiontes.termekTipus, kiontes.meret);
            const keszletMennyiseg = cimkeKeszlet[kulcs] || 0;
            const maxCimkezheto = Math.min(keszletMennyiseg, kiontes.darabszam);
            
            if (maxCimkezheto === 0) {
                alert('Nincs c√≠mke a k√©szletben!');
                return;
            }
            
            // Modal megnyit√°sa
            reszlegesCimkezesModal(kiontesId, kiontes, maxCimkezheto, keszletMennyiseg);
        }

        function reszlegesCimkezesModal(kiontesId, kiontes = null, maxCimkezheto = 0, keszletMennyiseg = 0) {
            const modal = document.getElementById('reszlegesCimkezesModal');
            
            if (kiontesId === null || kiontes === null) {
                // Bez√°r√°s
                modal.classList.add('hidden');
                reszlegesCimkezesData = null;
                return;
            }
            
            // Adatok t√°rol√°sa
            reszlegesCimkezesData = { kiontesId, kiontes, maxCimkezheto, keszletMennyiseg };
            
            // Info kit√∂lt√©se
            const info = document.getElementById('reszlegesCimkezesInfo');
            info.innerHTML = `
                <div class="font-medium mb-1">${kiontes.illatNev} - ${kiontes.termekTipusNev} - ${kiontes.meret}</div>
                <div class="text-sm text-gray-600">√ñsszes term√©k: ${kiontes.darabszam} db</div>
                <div class="text-sm text-gray-600">C√≠mke k√©szlet: ${keszletMennyiseg} db</div>
                <div class="text-sm font-semibold text-purple-700 mt-2">Maximum: ${maxCimkezheto} db</div>
            `;
            
            // Input √©rt√©k√©nek be√°ll√≠t√°sa
            document.getElementById('reszlegesMennyiseg').value = maxCimkezheto;
            document.getElementById('reszlegesMennyiseg').max = maxCimkezheto;
            
            // Modal megnyit√°sa
            modal.classList.remove('hidden');
        }

        function reszlegesCimkezesVegrehajt() {
            if (!reszlegesCimkezesData) return;
            
            const { kiontesId, kiontes, maxCimkezheto } = reszlegesCimkezesData;
            const szam = parseInt(document.getElementById('reszlegesMennyiseg').value);
            
            if (!szam || szam < 1 || szam > maxCimkezheto) {
                alert(`√ârv√©nytelen mennyis√©g! Add meg 1 √©s ${maxCimkezheto} k√∂z√∂tt!`);
                return;
            }
            
            const kulcs = getCimkeKulcs(kiontes.illatId, kiontes.termekTipus, kiontes.meret);
            
            // Levon√°s a c√≠mke k√©szletb≈ël
            cimkeKeszlet[kulcs] -= szam;
            
            // Csoportos c√≠mk√©z√©s eset√©n
            if (typeof kiontesId === 'string' && kiontesId.startsWith('csoport')) {
                // Megkeress√ºk az √∂sszes t√©telt
                const csoportTetelek = kiontesek.filter(k => 
                    k.illatId === kiontes.illatId && 
                    k.termekTipus === kiontes.termekTipus && 
                    k.meret === kiontes.meret
                );
                
                let maradekCimkezendo = szam;
                
                // C√≠mk√©z√©s sorrendben, am√≠g van c√≠mke
                for (const tetel of csoportTetelek) {
                    if (maradekCimkezendo <= 0) break;
                    
                    const cimkezettMennyiseg = Math.min(tetel.darabszam, maradekCimkezendo);
                    
                    // K√©sz term√©k l√©trehoz√°sa
                    keszTermekek.unshift({
                        ...tetel,
                        darabszam: cimkezettMennyiseg,
                        cimkezveIdopont: new Date().toISOString(),
                        id: generateId()
                    });
                    
                    tetel.darabszam -= cimkezettMennyiseg;
                    maradekCimkezendo -= cimkezettMennyiseg;
                }
                
                // T√∂rl√©s a 0-ra cs√∂kkent t√©telek
                kiontesek = kiontesek.filter(k => 
                    !(k.illatId === kiontes.illatId && 
                      k.termekTipus === kiontes.termekTipus && 
                      k.meret === kiontes.meret && 
                      k.darabszam <= 0)
                );
            } else {
                // Egyedi t√©tel r√©szleges c√≠mk√©z√©se
                const ujKeszTermek = {
                    ...kiontes,
                    darabszam: szam,
                    cimkezveIdopont: new Date().toISOString(),
                    id: generateId()
                };
                
                keszTermekek.unshift(ujKeszTermek);
                
                kiontes.darabszam -= szam;
                
                if (kiontes.darabszam <= 0) {
                    kiontesek = kiontesek.filter(k => k.id !== kiontesId);
                }
            }
            
            ment();
            render();
            
            // Modal bez√°r√°sa
            reszlegesCimkezesModal(null);
        }

        function toggleManualCimkeModal() {
            const modal = document.getElementById('manualCimkeModal');
            modal.classList.toggle('hidden');
            
            if (!modal.classList.contains('hidden')) {
                // Modal megnyit√°sa - popul√°ljuk a selecteket ABC SORRENDBEN
                const illatSelect = document.getElementById('manualCimkeIllat');
                const rendezetIllatok = [...illatok].sort((a, b) => a.nev.localeCompare(b.nev, 'hu'));
                illatSelect.innerHTML = '<option value="">V√°lassz megl√©v≈ë illatot...</option>' +
                    rendezetIllatok.map(i => `<option value="${i.id}">${i.nev}</option>`).join('');
                illatSelect.disabled = false; // FONTOS: Enable select
                
                const tipusSelect = document.getElementById('manualCimkeTermekTipus');
                tipusSelect.innerHTML = '<option value="">V√°lassz t√≠pust...</option>' +
                    termekTipusok.map(t => `<option value="${t.id}">${t.nev}</option>`).join('');
                
                // Mez≈ëk t√∂rl√©se
                document.getElementById('manualCimkeMeret').innerHTML = '<option value="">El≈ësz√∂r v√°lassz t√≠pust</option>';
                document.getElementById('manualCimkeMennyiseg').value = '';
                document.getElementById('ujIllatManualForm').classList.add('hidden');
                document.getElementById('ujIllatManualNev').value = '';
            }
        }

        function toggleUjIllatManual() {
            const form = document.getElementById('ujIllatManualForm');
            const select = document.getElementById('manualCimkeIllat');
            
            if (form.classList.contains('hidden')) {
                // Megnyit√°s
                form.classList.remove('hidden');
                select.value = '';
                select.disabled = true;
                document.getElementById('ujIllatManualNev').focus();
            } else {
                // Bez√°r√°s
                form.classList.add('hidden');
                select.disabled = false;
                document.getElementById('ujIllatManualNev').value = '';
            }
        }

        function manualCimkeIllatChange() {
            const select = document.getElementById('manualCimkeIllat');
            if (select.value) {
                // Ha selectb≈ël v√°lasztott, z√°rjuk be az √∫j illat formot
                const form = document.getElementById('ujIllatManualForm');
                if (!form.classList.contains('hidden')) {
                    toggleUjIllatManual();
                }
            }
        }

        function updateManualCimkeMeret() {
            const termekTipus = document.getElementById('manualCimkeTermekTipus').value;
            const meretSelect = document.getElementById('manualCimkeMeret');
            
            if (termekTipus && meretek[termekTipus]) {
                meretSelect.innerHTML = '<option value="">V√°lassz m√©retet...</option>' +
                    meretek[termekTipus].map(m => `<option value="${m}">${m}</option>`).join('');
            } else {
                meretSelect.innerHTML = '<option value="">El≈ësz√∂r v√°lassz t√≠pust</option>';
            }
        }

        async function manualCimkeHozzaad() {
            let illatId = parseInt(document.getElementById('manualCimkeIllat').value);
            const ujIllatNev = document.getElementById('ujIllatManualNev').value.trim();
            const termekTipus = document.getElementById('manualCimkeTermekTipus').value;
            const meret = document.getElementById('manualCimkeMeret').value;
            const mennyiseg = parseInt(document.getElementById('manualCimkeMennyiseg').value);
            
            // Ellen≈ërz√©s: illat select VAGY √∫j illat n√©v
            if (!illatId && !ujIllatNev) {
                alert('V√°lassz egy illatot vagy adj meg egy √∫j illat nevet!');
                return;
            }
            
            if (!termekTipus || !meret || !mennyiseg || mennyiseg < 1) {
                alert('K√©rlek t√∂ltsd ki az √∂sszes mez≈ët!');
                return;
            }
            
            // Ha √∫j illat, hozz√°adjuk
            if (ujIllatNev && !illatId) {
                // Duplik√°ci√≥ ellen≈ërz√©se
                const letezikMar = illatok.some(i => i.nev.toLowerCase() === ujIllatNev.toLowerCase());
                if (letezikMar) {
                    const letez≈ëIllat = illatok.find(i => i.nev.toLowerCase() === ujIllatNev.toLowerCase());
                    illatId = letez≈ëIllat.id;
                } else {
                    illatId = generateId();
                    illatok.push({ id: illatId, nev: ujIllatNev });
                    await ment(); // Mentj√ºk az √∫j illatot
                }
            }
            
            const kulcs = getCimkeKulcs(illatId, termekTipus, meret);
            
            if (!cimkeKeszlet[kulcs]) {
                cimkeKeszlet[kulcs] = 0;
            }
            cimkeKeszlet[kulcs] += mennyiseg;
            
            await ment();
            render();
            toggleManualCimkeModal();
            
            const illat = illatok.find(i => i.id === illatId);
            alert(`${mennyiseg} db c√≠mke hozz√°adva: ${illat.nev}`);
        }

        function toggleManualKeszTermekModal() {
            const modal = document.getElementById('manualKeszTermekModal');
            modal.classList.toggle('hidden');
            
            if (!modal.classList.contains('hidden')) {
                // Modal megnyit√°sa - popul√°ljuk a selecteket
                const illatSelect = document.getElementById('manualKeszTermekIllat');
                illatSelect.innerHTML = '<option value="">V√°lassz megl√©v≈ë illatot...</option>' +
                    illatok.map(i => `<option value="${i.id}">${i.nev}</option>`).join('');
                illatSelect.disabled = false; // FONTOS: Enable select
                
                const tipusSelect = document.getElementById('manualKeszTermekTermekTipus');
                tipusSelect.innerHTML = '<option value="">V√°lassz t√≠pust...</option>' +
                    termekTipusok.map(t => `<option value="${t.id}">${t.nev}</option>`).join('');
                
                // Mez≈ëk t√∂rl√©se
                document.getElementById('manualKeszTermekMeret').innerHTML = '<option value="">El≈ësz√∂r v√°lassz t√≠pust</option>';
                document.getElementById('manualKeszTermekMennyiseg').value = '';
                document.getElementById('ujIllatManualKeszTermekForm').classList.add('hidden');
                document.getElementById('ujIllatManualKeszTermekNev').value = '';
            }
        }

        function toggleUjIllatManualKeszTermek() {
            const form = document.getElementById('ujIllatManualKeszTermekForm');
            const select = document.getElementById('manualKeszTermekIllat');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                select.value = '';
                select.disabled = true;
                document.getElementById('ujIllatManualKeszTermekNev').focus();
            } else {
                form.classList.add('hidden');
                select.disabled = false;
                document.getElementById('ujIllatManualKeszTermekNev').value = '';
            }
        }

        function manualKeszTermekIllatChange() {
            const select = document.getElementById('manualKeszTermekIllat');
            if (select.value) {
                const form = document.getElementById('ujIllatManualKeszTermekForm');
                if (!form.classList.contains('hidden')) {
                    toggleUjIllatManualKeszTermek();
                }
            }
        }

        function updateManualKeszTermekMeret() {
            const termekTipus = document.getElementById('manualKeszTermekTermekTipus').value;
            const meretSelect = document.getElementById('manualKeszTermekMeret');
            
            if (termekTipus && meretek[termekTipus]) {
                meretSelect.innerHTML = '<option value="">V√°lassz m√©retet...</option>' +
                    meretek[termekTipus].map(m => `<option value="${m}">${m}</option>`).join('');
            } else {
                meretSelect.innerHTML = '<option value="">El≈ësz√∂r v√°lassz t√≠pust</option>';
            }
        }

        let szerkesztKeszTermekData = null; // Szerkeszt√©s √°llapot t√°rol√°sa

        function keszTermekSzerkeszt(illatNev, termekTipusNev, meret, osszesDarab) {
            szerkesztKeszTermekData = { illatNev, termekTipusNev, meret, osszesDarab };
            
            const modal = document.getElementById('szerkesztKeszTermekModal');
            const info = document.getElementById('szerkesztKeszTermekInfo');
            const mennyisegInput = document.getElementById('szerkesztKeszTermekMennyiseg');
            
            info.innerHTML = `
                <div class="font-medium mb-1">${illatNev}</div>
                <div class="text-sm text-gray-600">${termekTipusNev} - ${meret}</div>
                <div class="text-sm text-gray-600 mt-2">Jelenlegi mennyis√©g: <span class="font-bold">${osszesDarab} db</span></div>
            `;
            
            mennyisegInput.value = osszesDarab;
            modal.classList.remove('hidden');
        }

        function keszTermekMennyisegValtoztat(valtozas) {
            const input = document.getElementById('szerkesztKeszTermekMennyiseg');
            const jelenlegiErtek = parseInt(input.value) || 0;
            const ujErtek = Math.max(0, jelenlegiErtek + valtozas);
            input.value = ujErtek;
        }

        async function keszTermekSzerkesztMent() {
            if (!szerkesztKeszTermekData) return;
            
            const ujMennyiseg = parseInt(document.getElementById('szerkesztKeszTermekMennyiseg').value);
            
            if (isNaN(ujMennyiseg) || ujMennyiseg < 0) {
                alert('√ârv√©nytelen mennyis√©g!');
                return;
            }
            
            const { illatNev, termekTipusNev, meret, osszesDarab } = szerkesztKeszTermekData;
            
            if (ujMennyiseg === 0) {
                if (!confirm('A mennyis√©g 0 lesz. Ez t√∂r√∂lni fogja ezt a term√©ket. Biztosan folytatod?')) {
                    return;
                }
            }
            
            // Megkeress√ºk az √∂sszes t√©telt
            const tetelek = keszTermekek.filter(t => 
                t.illatNev === illatNev && 
                t.termekTipusNev === termekTipusNev && 
                t.meret === meret
            );
            
            if (ujMennyiseg === 0) {
                // T√∂rl√©s
                keszTermekek = keszTermekek.filter(t => 
                    !(t.illatNev === illatNev && 
                      t.termekTipusNev === termekTipusNev && 
                      t.meret === meret)
                );
            } else {
                // Ar√°nyos m√≥dos√≠t√°s
                const arany = ujMennyiseg / osszesDarab;
                tetelek.forEach(tetel => {
                    tetel.darabszam = Math.round(tetel.darabszam * arany);
                });
            }
            
            await ment();
            render();
            keszTermekSzerkesztBezar();
        }

        function keszTermekSzerkesztBezar() {
            document.getElementById('szerkesztKeszTermekModal').classList.add('hidden');
            szerkesztKeszTermekData = null;
        }

        async function manualKeszTermekHozzaad() {
            let illatId = parseInt(document.getElementById('manualKeszTermekIllat').value);
            const ujIllatNev = document.getElementById('ujIllatManualKeszTermekNev').value.trim();
            const termekTipus = document.getElementById('manualKeszTermekTermekTipus').value;
            const meret = document.getElementById('manualKeszTermekMeret').value;
            const mennyiseg = parseInt(document.getElementById('manualKeszTermekMennyiseg').value);
            
            // Ellen≈ërz√©s
            if (!illatId && !ujIllatNev) {
                alert('V√°lassz egy illatot vagy adj meg egy √∫j illat nevet!');
                return;
            }
            
            if (!termekTipus || !meret || !mennyiseg || mennyiseg < 1) {
                alert('K√©rlek t√∂ltsd ki az √∂sszes mez≈ët!');
                return;
            }
            
            // Ha √∫j illat, hozz√°adjuk
            if (ujIllatNev && !illatId) {
                // Duplik√°ci√≥ ellen≈ërz√©se
                const letezikMar = illatok.some(i => i.nev.toLowerCase() === ujIllatNev.toLowerCase());
                if (letezikMar) {
                    const letez≈ëIllat = illatok.find(i => i.nev.toLowerCase() === ujIllatNev.toLowerCase());
                    illatId = letez≈ëIllat.id;
                } else {
                    illatId = generateId();
                    illatok.push({ id: illatId, nev: ujIllatNev });
                }
            }
            
            const illat = illatok.find(i => i.id === illatId);
            const termekTipusObj = termekTipusok.find(t => t.id === termekTipus);
            
            // K√©sz term√©k l√©trehoz√°sa - NEM VON LE C√çMK√âT!
            const ujKeszTermek = {
                id: generateId(),
                illatId: illatId,
                illatNev: illat.nev,
                termekTipus: termekTipus,
                termekTipusNev: termekTipusObj.nev,
                meret: meret,
                darabszam: mennyiseg,
                datum: new Date().toISOString(),
                cimkezveIdopont: new Date().toISOString(),
                megjegyzes: 'Manu√°lisan hozz√°adva (polcon l√©v≈ë k√©szlet)'
            };
            
            keszTermekek.unshift(ujKeszTermek);
            
            await ment();
            render();
            toggleManualKeszTermekModal();
            
            alert(`${mennyiseg} db k√©sz term√©k hozz√°adva: ${illat.nev}\n(C√≠mke k√©szlet nem v√°ltozott)`);
        }

        function keszTermekTorol(id) {
            if (confirm('Biztosan t√∂rl√∂d ezt a k√©sz term√©ket?')) {
                keszTermekek = keszTermekek.filter(k => k.id !== id);
                ment();
                render();
            }
        }

        function csoportTorol(illatNev, termekTipusNev, meret) {
            if (confirm(`Biztosan t√∂rl√∂d az √∂sszes k√©sz term√©ket ebb≈ël: ${illatNev} - ${termekTipusNev} - ${meret}?`)) {
                // T√∂rl√©s a csoportb√≥l - minden t√©tel ami megegyezik
                keszTermekek = keszTermekek.filter(k => 
                    !(k.illatNev === illatNev && k.termekTipusNev === termekTipusNev && k.meret === meret)
                );
                ment();
                render();
            }
        }

        function updateMeretOptions() {
            const termekTipus = document.getElementById('termekTipus').value;
            const meretSelect = document.getElementById('meret');
            
            if (termekTipus && meretek[termekTipus]) {
                meretSelect.innerHTML = '<option value="">V√°lassz m√©retet...</option>' +
                    meretek[termekTipus].map(m => `<option value="${m}">${m}</option>`).join('');
            } else {
                meretSelect.innerHTML = '<option value="">El≈ësz√∂r v√°lassz term√©k t√≠pust</option>';
            }
        }

        function toggleUjIllat() {
            const form = document.getElementById('ujIllatForm');
            form.classList.toggle('hidden');
            if (!form.classList.contains('hidden')) {
                document.getElementById('ujIllatNev').focus();
            }
        }

        function toggleIllatSzerkesztes() {
            const modal = document.getElementById('illatSzerkesztesModal');
            const form = document.getElementById('szerkesztIllatForm');
            const select = document.getElementById('szerkesztIllatSelect');
            
            if (modal.classList.contains('hidden')) {
                // Megnyit√°s
                modal.classList.remove('hidden');
                form.classList.add('hidden');
                
                // Illatok bet√∂lt√©se ABC sorrendben
                const rendezetIllatok = [...illatok].sort((a, b) => a.nev.localeCompare(b.nev, 'hu'));
                select.innerHTML = '<option value="">V√°lassz illatot...</option>' +
                    rendezetIllatok.map(i => `<option value="${i.id}">${i.nev}</option>`).join('');
                
                // Esem√©nykezel≈ë
                select.onchange = illatSzerkesztesValasztas;
            } else {
                // Bez√°r√°s
                modal.classList.add('hidden');
                form.classList.add('hidden');
                select.value = '';
                document.getElementById('szerkesztIllatUjNev').value = '';
            }
        }

        function illatSzerkesztesValasztas() {
            const illatId = parseInt(document.getElementById('szerkesztIllatSelect').value);
            const form = document.getElementById('szerkesztIllatForm');
            
            if (illatId) {
                const illat = illatok.find(i => i.id === illatId);
                document.getElementById('szerkesztIllatJelenlegiNev').textContent = illat.nev;
                document.getElementById('szerkesztIllatUjNev').value = illat.nev;
                form.classList.remove('hidden');
            } else {
                form.classList.add('hidden');
            }
        }

        async function illatSzerkesztMent() {
            const illatId = parseInt(document.getElementById('szerkesztIllatSelect').value);
            const ujNev = document.getElementById('szerkesztIllatUjNev').value.trim();
            
            if (!illatId || !ujNev) {
                alert('Adj meg egy √∫j nevet!');
                return;
            }
            
            const illat = illatok.find(i => i.id === illatId);
            const regiNev = illat.nev;
            
            // Duplik√°ci√≥ ellen≈ërz√©se (kiv√©ve saj√°t mag√°t)
            const letezikMar = illatok.some(i => i.id !== illatId && i.nev.toLowerCase() === ujNev.toLowerCase());
            if (letezikMar) {
                alert(`"${ujNev}" illat m√°r l√©tezik!`);
                return;
            }
            
            if (!confirm(`Biztosan √°tnevezed "${regiNev}" illatot "${ujNev}" n√©vre?\n\nEz minden term√©kn√©l friss√ºl!`)) {
                return;
            }
            
            // Illat n√©v friss√≠t√©se
            illat.nev = ujNev;
            
            // Minden term√©kben friss√≠t√©s ahol ez az illat szerepel
            kiontesek.forEach(k => {
                if (k.illatId === illatId) k.illatNev = ujNev;
            });
            
            keszTermekek.forEach(k => {
                if (k.illatId === illatId) k.illatNev = ujNev;
            });
            
            await ment();
            render();
            toggleIllatSzerkesztes();
            
            alert(`‚úÖ "${regiNev}" √°tnevezve "${ujNev}" n√©vre!`);
        }

        function illatStatisztika(illatId) {
            const illat = illatok.find(i => i.id === illatId);
            if (!illat) return;
            
            const modal = document.getElementById('illatStatisztikaModal');
            const cim = document.getElementById('illatStatisztikaCim');
            const content = document.getElementById('illatStatisztikaContent');
            
            cim.textContent = `üìä ${illat.nev} - R√©szletes statisztika`;
            
            // √ñsszes t√≠pus-m√©ret kombin√°ci√≥ gy≈±jt√©se
            const osszesKombinacio = new Set();
            
            // Adatok gy≈±jt√©se
            const cimkezetlenTermekek = {};
            const cimkeKeszletAdatok = {};
            const keszTermekAdatok = {};
            
            // C√≠mk√©zetlen term√©kek - ID szerint
            kiontesek.forEach(k => {
                if (k.illatId === illatId) {
                    const kulcs = `${k.termekTipusNev} - ${k.meret}`;
                    osszesKombinacio.add(kulcs);
                    cimkezetlenTermekek[kulcs] = (cimkezetlenTermekek[kulcs] || 0) + k.darabszam;
                }
            });
            
            // C√≠mke k√©szlet - ID szerint
            Object.keys(cimkeKeszlet).forEach(kulcs => {
                const [cimkeIllatId, termekTipus, meret] = kulcs.split('-');
                if (parseInt(cimkeIllatId) === illatId) {
                    const termekTipusObj = termekTipusok.find(t => t.id === termekTipus);
                    const tipus = termekTipusObj ? termekTipusObj.nev : termekTipus;
                    const megnevezes = `${tipus} - ${meret}`;
                    osszesKombinacio.add(megnevezes);
                    cimkeKeszletAdatok[megnevezes] = cimkeKeszlet[kulcs];
                }
            });
            
            // K√©sz term√©kek - N√âV szerint (mert manu√°lis hozz√°ad√°sn√°l lehet m√°s az ID!)
            keszTermekek.forEach(k => {
                if (k.illatNev === illat.nev) {
                    const kulcs = `${k.termekTipusNev} - ${k.meret}`;
                    osszesKombinacio.add(kulcs);
                    keszTermekAdatok[kulcs] = (keszTermekAdatok[kulcs] || 0) + k.darabszam;
                }
            });
            
            // Kisz√°ll√≠t√°sok - N√âV szerint
            const illatKiszallitasok = kiszallitasok.filter(k => k.illatNev === illat.nev);
            const osszesKiszallitva = illatKiszallitasok.reduce((sum, k) => sum + k.mennyiseg, 0);
            const eladasok = illatKiszallitasok.filter(k => k.tipus === 'eladas').reduce((sum, k) => sum + k.mennyiseg, 0);
            const fulfilment = illatKiszallitasok.filter(k => k.tipus === 'fulfilment').reduce((sum, k) => sum + k.mennyiseg, 0);
            
            // Kombin√°ci√≥k rendez√©se ABC szerint
            const kombinaciokRendezve = Array.from(osszesKombinacio).sort((a, b) => a.localeCompare(b, 'hu'));
            
            // √ñsszes√≠t≈ëk
            const cimkezetlenOsszesen = Object.values(cimkezetlenTermekek).reduce((a, b) => a + b, 0);
            const cimkeKeszletOsszesen = Object.values(cimkeKeszletAdatok).reduce((a, b) => a + b, 0);
            const keszTermekOsszesen = Object.values(keszTermekAdatok).reduce((a, b) => a + b, 0);
            const gyartvaOsszesen = cimkezetlenOsszesen + keszTermekOsszesen + osszesKiszallitva;
            
            // HTML √©p√≠t√©se - MINDIG UGYANAZ A STRUKT√öRA
            let html = '';
            
            // 1. C√çMK√âZETLEN TERM√âKEK (mindig megjelenik)
            html += `
                <div class="bg-orange-50 p-4 rounded-lg border-2 border-orange-200">
                    <h3 class="font-bold text-orange-900 mb-2">üè≠ C√≠mk√©zetlen term√©kek</h3>
            `;
            if (kombinaciokRendezve.length > 0) {
                kombinaciokRendezve.forEach(tipus => {
                    const db = cimkezetlenTermekek[tipus] || 0;
                    html += `<div class="text-sm text-gray-700 ml-4">‚Ä¢ ${tipus}: <span class="font-bold">${db} db</span></div>`;
                });
            } else {
                html += `<div class="text-sm text-gray-500 ml-4 italic">Nincs adat</div>`;
            }
            html += `<div class="text-sm font-bold text-orange-900 mt-2">√ñsszesen: ${cimkezetlenOsszesen} db</div></div>`;
            
            // 2. C√çMKE K√âSZLET (mindig megjelenik)
            html += `
                <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                    <h3 class="font-bold text-blue-900 mb-2">üè∑Ô∏è C√≠mke k√©szlet</h3>
            `;
            if (kombinaciokRendezve.length > 0) {
                kombinaciokRendezve.forEach(tipus => {
                    const db = cimkeKeszletAdatok[tipus] || 0;
                    html += `<div class="text-sm text-gray-700 ml-4">‚Ä¢ ${tipus}: <span class="font-bold">${db} db</span></div>`;
                });
            } else {
                html += `<div class="text-sm text-gray-500 ml-4 italic">Nincs adat</div>`;
            }
            html += `<div class="text-sm font-bold text-blue-900 mt-2">√ñsszesen: ${cimkeKeszletOsszesen} db</div></div>`;
            
            // 3. POLCON (K√âSZ TERM√âKEK) (mindig megjelenik)
            html += `
                <div class="bg-emerald-50 p-4 rounded-lg border-2 border-emerald-200">
                    <h3 class="font-bold text-emerald-900 mb-2">‚úÖ Polcon (k√©sz term√©kek)</h3>
            `;
            if (kombinaciokRendezve.length > 0) {
                kombinaciokRendezve.forEach(tipus => {
                    const db = keszTermekAdatok[tipus] || 0;
                    html += `<div class="text-sm text-gray-700 ml-4">‚Ä¢ ${tipus}: <span class="font-bold">${db} db</span></div>`;
                });
            } else {
                html += `<div class="text-sm text-gray-500 ml-4 italic">Nincs adat</div>`;
            }
            html += `<div class="text-sm font-bold text-emerald-900 mt-2">√ñsszesen: ${keszTermekOsszesen} db</div></div>`;
            
            // 4. KISZ√ÅLL√çTVA (mindig megjelenik)
            const utolsoKiszallitas = illatKiszallitasok.length > 0 
                ? formatDatum(illatKiszallitasok[0].datum) 
                : '-';
            
            // Kisz√°ll√≠t√°sok t√≠pusonk√©nt (term√©k t√≠pus + m√©ret)
            const kiszallitasTipusonkent = {};
            illatKiszallitasok.forEach(k => {
                const kulcs = `${k.termekTipusNev} - ${k.meret}`;
                kiszallitasTipusonkent[kulcs] = (kiszallitasTipusonkent[kulcs] || 0) + k.mennyiseg;
            });
            
            // Rendez√©s ABC szerint
            const kiszallitasTipusokRendezve = Object.entries(kiszallitasTipusonkent)
                .sort(([a], [b]) => a.localeCompare(b, 'hu'));
            
            html += `
                <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200">
                    <h3 class="font-bold text-purple-900 mb-2">üì§ Kisz√°ll√≠tva</h3>
            `;
            
            // T√≠pusonk√©nt bont√°s
            if (kiszallitasTipusokRendezve.length > 0) {
                html += `<div class="text-xs font-semibold text-purple-800 mb-1 ml-4">T√≠pusonk√©nt:</div>`;
                kiszallitasTipusokRendezve.forEach(([tipus, db]) => {
                    html += `<div class="text-sm text-gray-700 ml-4">‚Ä¢ ${tipus}: <span class="font-bold">${db} db</span></div>`;
                });
                html += `<div class="border-t border-purple-200 my-2"></div>`;
            }
            
            // Kisz√°ll√≠t√°s t√≠pusa
            html += `
                <div class="text-xs font-semibold text-purple-800 mb-1 ml-4">Kisz√°ll√≠t√°s t√≠pusa:</div>
                <div class="text-sm text-gray-700 ml-4">‚Ä¢ Elad√°s: <span class="font-bold text-green-700">${eladasok} db</span> üõí</div>
                <div class="text-sm text-gray-700 ml-4">‚Ä¢ Fulfilment: <span class="font-bold text-blue-700">${fulfilment} db</span> üì¶</div>
                <div class="border-t border-purple-200 my-2"></div>
                <div class="text-sm text-gray-600 ml-4">Utols√≥ kisz√°ll√≠t√°s: ${utolsoKiszallitas}</div>
                <div class="text-sm font-bold text-purple-900 mt-2">√ñsszesen: ${osszesKiszallitva} db</div>
            </div>
            `;
            
            // 5. √ñSSZES√çT≈ê
            html += `
                <div class="bg-gradient-to-r from-amber-100 to-yellow-100 p-4 rounded-lg border-2 border-amber-300">
                    <h3 class="font-bold text-amber-900 mb-2">üìà √ñsszes√≠t≈ë</h3>
                    <div class="text-sm text-gray-700">‚Ä¢ Gy√°rtva √∂sszesen: <span class="font-bold">${gyartvaOsszesen} db</span></div>
                    <div class="text-sm text-gray-700">‚Ä¢ Polcon van: <span class="font-bold text-emerald-700">${keszTermekOsszesen} db</span></div>
                    <div class="text-sm text-gray-700">‚Ä¢ Kisz√°ll√≠tva: <span class="font-bold text-purple-700">${osszesKiszallitva} db</span></div>
                    <div class="text-sm text-gray-700">‚Ä¢ C√≠mk√©zetlen: <span class="font-bold text-orange-700">${cimkezetlenOsszesen} db</span></div>
                </div>
            `;
            
            content.innerHTML = html;
            modal.classList.remove('hidden');
        }

        function illatStatisztikaModalBezar() {
            document.getElementById('illatStatisztikaModal').classList.add('hidden');
        }

        function illatHozzaad() {
            const nev = document.getElementById('ujIllatNev').value.trim();
            if (nev) {
                // Duplik√°ci√≥ ellen≈ërz√©se (case-insensitive)
                const letezikMar = illatok.some(i => i.nev.toLowerCase() === nev.toLowerCase());
                if (letezikMar) {
                    alert(`"${nev}" illat m√°r l√©tezik a list√°ban!`);
                    return;
                }
                
                illatok.push({ id: generateId(), nev });
                document.getElementById('ujIllatNev').value = '';
                toggleUjIllat();
                ment();
                render();
            }
        }

        function illatTorol(id) {
            if (confirm('Biztosan t√∂rl√∂d ezt az illatot?')) {
                illatok = illatok.filter(i => i.id !== id);
                ment();
                render();
            }
        }

        function kiontesHozzaad() {
            const termekTipus = document.getElementById('termekTipus').value;
            const meret = document.getElementById('meret').value;
            const illatId = parseInt(document.getElementById('kivalasztottIllat').value);
            const darab = parseInt(document.getElementById('darabszam').value);
            const megj = document.getElementById('megjegyzes').value.trim();
            
            if (termekTipus && meret && illatId && darab > 0) {
                const illat = illatok.find(i => i.id === illatId);
                const termekTipusObj = termekTipusok.find(t => t.id === termekTipus);
                
                kiontesek.unshift({
                    id: generateId(),
                    termekTipus: termekTipus,
                    termekTipusNev: termekTipusObj.nev,
                    meret: meret,
                    illatId,
                    illatNev: illat.nev,
                    darabszam: darab,
                    datum: new Date().toISOString(),
                    megjegyzes: megj,
                    cimkeGyartva: false
                });
                
                document.getElementById('termekTipus').value = '';
                document.getElementById('meret').innerHTML = '<option value="">El≈ësz√∂r v√°lassz term√©k t√≠pust</option>';
                document.getElementById('kivalasztottIllat').value = '';
                document.getElementById('darabszam').value = '';
                document.getElementById('megjegyzes').value = '';
                
                ment();
                render();
            } else {
                alert('K√©rlek t√∂ltsd ki az √∂sszes k√∂telez≈ë mez≈ët!');
            }
        }

        function cimkeToggle(id) {
            const kiontes = kiontesek.find(k => k.id === id);
            if (kiontes) {
                kiontes.cimkeGyartva = !kiontes.cimkeGyartva;
                // Ha most lett k√©sz a c√≠mke, r√∂gz√≠tj√ºk a d√°tumot
                if (kiontes.cimkeGyartva) {
                    kiontes.cimkeGyartvaIdopont = new Date().toISOString();
                } else {
                    // Ha visszav√°ltjuk "nincs k√©sz" √°llapotra, t√∂r√∂lj√ºk a d√°tumot
                    delete kiontes.cimkeGyartvaIdopont;
                }
                ment();
                render();
            }
        }

        function kiontesTorol(id) {
            if (confirm('Biztosan t√∂rl√∂d ezt a ki√∂nt√©st?')) {
                kiontesek = kiontesek.filter(k => k.id !== id);
                ment();
                render();
            }
        }

        function formatDatum(isoString) {
            const date = new Date(isoString);
            const options = { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('hu-HU', options);
        }

        function render() {
            // Illat lista - ABC SORREND
            const illatLista = document.getElementById('illatLista');
            if (illatok.length === 0) {
                illatLista.innerHTML = '<p class="text-gray-500 text-center py-8">M√©g nincs illat hozz√°adva</p>';
            } else {
                const rendezetIllatok = [...illatok].sort((a, b) => a.nev.localeCompare(b.nev, 'hu'));
                illatLista.innerHTML = rendezetIllatok.map(illat => `
                    <div class="flex justify-between items-center p-3 bg-amber-50 rounded-lg hover:bg-amber-100 transition">
                        <span class="font-medium text-amber-900 cursor-pointer hover:text-amber-700 flex-1" 
                              onclick="illatStatisztika(${illat.id})" 
                              title="Kattints a r√©szletes statisztik√°hoz">
                            ${illat.nev} üìä
                        </span>
                        <button onclick="illatTorol(${illat.id})" class="text-red-600 hover:text-red-800 text-sm ml-2">
                            T√∂rl√©s
                        </button>
                    </div>
                `).join('');
            }

            // Term√©k t√≠pus select
            const termekTipusSelect = document.getElementById('termekTipus');
            if (termekTipusSelect) {
                termekTipusSelect.innerHTML = '<option value="">V√°lassz term√©k t√≠pust...</option>' +
                    termekTipusok.map(t => `<option value="${t.id}">${t.nev}</option>`).join('');
            }

            // Illat select - ABC SORREND
            const select = document.getElementById('kivalasztottIllat');
            const rendezetIllatok = [...illatok].sort((a, b) => a.nev.localeCompare(b.nev, 'hu'));
            select.innerHTML = '<option value="">V√°lassz illatot...</option>' + 
                rendezetIllatok.map(illat => `<option value="${illat.id}">${illat.nev}</option>`).join('');

            // Nyomtat√°s illat select
            const nyomtatasIllatSelect = document.getElementById('nyomtatasIllat');
            if (nyomtatasIllatSelect) {
                nyomtatasIllatSelect.innerHTML = '<option value="">V√°lassz illatot...</option>' + 
                    illatok.map(illat => `<option value="${illat.id}">${illat.nev}</option>`).join('');
            }

            // Nyomtat√°s term√©k t√≠pus select
            const nyomtatasTermekSelect = document.getElementById('nyomtatasTermekTipus');
            if (nyomtatasTermekSelect) {
                nyomtatasTermekSelect.innerHTML = '<option value="">V√°lassz term√©k t√≠pust...</option>' +
                    termekTipusok.map(t => `<option value="${t.id}">${t.nev}</option>`).join('');
            }

            // Gyors nyomtat√°s lista - ki√∂nt√∂tt term√©kek alapj√°n - CSAK AHOL HI√ÅNYZIK C√çMKE
            const gyorsNyomtatasLista = document.getElementById('gyorsNyomtatasLista');
            if (gyorsNyomtatasLista) {
                // Egyedi kombin√°ci√≥k gy≈±jt√©se
                const kombinaciok = new Map();
                
                kiontesek.forEach(k => {
                    if (k.termekTipusNev && k.meret) {
                        const kulcs = `${k.illatId}-${k.termekTipus}-${k.meret}`;
                        if (!kombinaciok.has(kulcs)) {
                            kombinaciok.set(kulcs, {
                                illatId: k.illatId,
                                illatNev: k.illatNev,
                                termekTipus: k.termekTipus,
                                termekTipusNev: k.termekTipusNev,
                                meret: k.meret,
                                osszesTermek: 0
                            });
                        }
                        kombinaciok.get(kulcs).osszesTermek += k.darabszam;
                    }
                });
                
                const kombinaciokTomb = Array.from(kombinaciok.values());
                
                // Sz≈±r√©s: csak ahol hi√°nyzik c√≠mke
                const hianyzosCimkek = kombinaciokTomb.filter(komb–æ => {
                    const cimkeKulcs = getCimkeKulcs(komb–æ.illatId, komb–æ.termekTipus, komb–æ.meret);
                    const keszlet = cimkeKeszlet[cimkeKulcs] || 0;
                    const hianyzo = Math.max(0, komb–æ.osszesTermek - keszlet);
                    return hianyzo > 0; // Csak ahol t√©nyleg hi√°nyzik
                });
                
                if (hianyzosCimkek.length === 0) {
                    gyorsNyomtatasLista.innerHTML = '<div class="text-center py-8"><p class="text-green-600 font-semibold text-lg">‚úÖ Minden c√≠mke k√©szleten van!</p><p class="text-gray-500 text-sm mt-1">Nem kell nyomtatni.</p></div>';
                } else {
                    gyorsNyomtatasLista.innerHTML = hianyzosCimkek.map(komb–æ => {
                        const cimkeKulcs = getCimkeKulcs(komb–æ.illatId, komb–æ.termekTipus, komb–æ.meret);
                        const keszlet = cimkeKeszlet[cimkeKulcs] || 0;
                        const hianyzo = Math.max(0, komb–æ.osszesTermek - keszlet);
                        const ajanlottLapok = Math.ceil(hianyzo / 12);
                        
                        return `
                            <div class="p-3 rounded border bg-orange-50 border-orange-300">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-1">
                                        <div class="font-medium text-sm">${komb–æ.illatNev}</div>
                                        <div class="text-xs text-gray-600">${komb–æ.termekTipusNev} - ${komb–æ.meret}</div>
                                        <div class="text-xs mt-1">
                                            <span class="text-gray-600">Term√©k: ${komb–æ.osszesTermek} db</span> | 
                                            <span class="text-green-600">C√≠mke: ${keszlet} db</span>
                                        </div>
                                        <div class="text-xs font-bold text-orange-700 mt-1">‚ö†Ô∏è Hi√°nyzik: ${hianyzo} db (${ajanlottLapok} lap)</div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <input type="number" id="lapok-${komb–æ.illatId}-${komb–æ.termekTipus}-${komb–æ.meret}" min="1" value="${ajanlottLapok}" 
                                        class="w-20 px-2 py-1 text-sm border rounded" placeholder="Lapok">
                                    <button onclick="gyorsNyomtatas(${komb–æ.illatId}, '${komb–æ.termekTipus}', '${komb–æ.meret}')" 
                                        class="flex-1 px-3 py-1 text-sm rounded bg-blue-600 hover:bg-blue-700 text-white">
                                        üñ®Ô∏è Nyomtat
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            // C√≠mke k√©szlet lista - MINDIG L√ÅTSZIK
            const cimkeKeszletLista = document.getElementById('cimkeKeszletLista');
            if (cimkeKeszletLista) {
                const keszletHTML = [];
                
                // El≈ësz√∂r gy≈±jtj√ºk √∂ssze az √ñSSZES kombin√°ci√≥t (ki√∂nt√∂tt + k√©szlet)
                const osszesKombinacio = new Map();
                
                // 1. Ki√∂nt√∂tt term√©kek kombin√°ci√≥i
                kiontesek.forEach(k => {
                    if (k.termekTipusNev && k.meret) {
                        const kulcs = getCimkeKulcs(k.illatId, k.termekTipus, k.meret);
                        if (!osszesKombinacio.has(kulcs)) {
                            osszesKombinacio.set(kulcs, {
                                illatId: k.illatId,
                                illatNev: k.illatNev,
                                termekTipus: k.termekTipus,
                                termekTipusNev: k.termekTipusNev,
                                meret: k.meret,
                                kulcs: kulcs
                            });
                        }
                    }
                });
                
                // 2. C√≠mke k√©szletben l√©v≈ë kombin√°ci√≥k (amikhez m√°r nincs term√©k)
                for (let kulcs in cimkeKeszlet) {
                    if (cimkeKeszlet[kulcs] > 0 && !osszesKombinacio.has(kulcs)) {
                        const [illatId, termekTipus, meret] = kulcs.split('-');
                        const illat = illatok.find(i => i.id === parseInt(illatId));
                        const termekTipusObj = termekTipusok.find(t => t.id === termekTipus);
                        
                        if (illat && termekTipusObj) {
                            osszesKombinacio.set(kulcs, {
                                illatId: parseInt(illatId),
                                illatNev: illat.nev,
                                termekTipus: termekTipus,
                                termekTipusNev: termekTipusObj.nev,
                                meret: meret,
                                kulcs: kulcs
                            });
                        }
                    }
                }
                
                // Rendez√©s ABC sorrendbe √©s megjelen√≠t√©s
                const rendezetKombinacio = Array.from(osszesKombinacio.values())
                    .sort((a, b) => a.illatNev.localeCompare(b.illatNev, 'hu'));
                
                rendezetKombinacio.forEach(info => {
                    const mennyiseg = cimkeKeszlet[info.kulcs] || 0;
                    const cssClass = mennyiseg < 12 ? 'bg-red-50 border-red-300' : mennyiseg === 0 ? 'bg-gray-50 border-gray-300' : 'bg-green-50 border-green-300';
                    
                    keszletHTML.push(`
                        <div class="p-3 rounded border ${cssClass}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium text-sm">${info.illatNev}</div>
                                    <div class="text-xs text-gray-600">${info.termekTipusNev} - ${info.meret}</div>
                                    <div class="font-bold mt-1 ${mennyiseg < 12 && mennyiseg > 0 ? 'text-red-700' : mennyiseg === 0 ? 'text-gray-500' : 'text-green-700'}">${mennyiseg} db</div>
                                </div>
                                <button onclick="cimkeKeszletSzerkeszt('${info.kulcs}', '${info.illatNev}', '${info.termekTipusNev}', '${info.meret}')" class="text-blue-600 hover:text-blue-800 text-xs">
                                    ‚úèÔ∏è Szerkeszt
                                </button>
                            </div>
                        </div>
                    `);
                });
                
                if (keszletHTML.length === 0) {
                    cimkeKeszletLista.innerHTML = '<p class="text-gray-500 text-sm">M√©g nincs c√≠mke k√©szlet</p>';
                } else {
                    cimkeKeszletLista.innerHTML = keszletHTML.join('');
                }
            }

            // √ñsszes√≠t√©s term√©k t√≠pusonk√©nt, m√©retenk√©nt √©s illatonk√©nt
            const osszesitesMap = new Map();
            
            kiontesek.forEach(k => {
                // Csak azokat dolgozzuk fel, amiknek van termekTipusNev √©s meret (√∫j form√°tum)
                if (k.termekTipusNev && k.meret) {
                    const kulcs = `${k.termekTipusNev}|${k.meret}|${k.illatNev}`;
                    if (!osszesitesMap.has(kulcs)) {
                        osszesitesMap.set(kulcs, {
                            termekTipusNev: k.termekTipusNev,
                            meret: k.meret,
                            illatNev: k.illatNev,
                            illatId: k.illatId,
                            termekTipus: k.termekTipus,
                            osszesDarab: 0,
                            cimkeNelkul: 0
                        });
                    }
                    const item = osszesitesMap.get(kulcs);
                    item.osszesDarab += k.darabszam;
                    if (!k.cimkeGyartva) {
                        item.cimkeNelkul += k.darabszam;
                    }
                }
            });

            const osszesites = Array.from(osszesitesMap.values());

            const cimkeDiv = document.getElementById('cimkeOsszesites');
            
            // Sz≈±r√©s: csak azok ahol hi√°nyzik c√≠mke
            const hianyzosCimkek = osszesites.filter(item => {
                const cimkeKulcs = getCimkeKulcs(item.illatId, item.termekTipus, item.meret);
                const keszlet = cimkeKeszlet[cimkeKulcs] || 0;
                const hianyzo = Math.max(0, item.cimkeNelkul - keszlet);
                return hianyzo > 0; // Csak ahol t√©nyleg hi√°nyzik
            });
            
            if (hianyzosCimkek.length > 0) {
                cimkeDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-orange-600 to-red-600 rounded-xl shadow-lg p-6 text-white">
                        <h2 class="text-2xl font-bold mb-4">‚ö†Ô∏è C√≠mk√©k gy√°rt√°sa</h2>
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${hianyzosCimkek.map(item => {
                                const cimkeKulcs = getCimkeKulcs(item.illatId, item.termekTipus, item.meret);
                                const keszlet = cimkeKeszlet[cimkeKulcs] || 0;
                                const hianyzo = Math.max(0, item.cimkeNelkul - keszlet);
                                
                                return `
                                <div class="bg-white/20 backdrop-blur rounded-lg p-4">
                                    <div class="font-bold text-lg mb-1">${item.illatNev}</div>
                                    <div class="text-sm opacity-90">${item.termekTipusNev} - ${item.meret}</div>
                                    <div class="text-sm opacity-90 mt-1">Term√©k: ${item.cimkeNelkul} db</div>
                                    <div class="text-sm opacity-90">C√≠mke k√©szlet: ${keszlet} db</div>
                                    <div class="text-xl font-bold mt-2 bg-yellow-400 text-yellow-900 rounded px-2 py-1 inline-block">
                                        ‚ö†Ô∏è ${hianyzo} db c√≠mke kell
                                    </div>
                                </div>
                            `;}).join('')}
                        </div>
                    </div>
                `;
            } else if (osszesites.length > 0) {
                // Van term√©k, de minden c√≠mke megvan
                cimkeDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl shadow-lg p-6 text-white text-center">
                        <h2 class="text-2xl font-bold mb-2">‚úÖ Minden c√≠mke k√©szen van!</h2>
                        <p class="text-green-100">Nincs sz√ºks√©g c√≠mkenyomtat√°sra.</p>
                    </div>
                `;
            } else {
                cimkeDiv.innerHTML = '';
            }

            // Ki√∂nt√©sek lista - CSOPORTOS√çTVA
            const kiontesLista = document.getElementById('kiontesLista');
            if (kiontesek.length === 0) {
                kiontesLista.innerHTML = '<p class="text-gray-500 text-center py-8">M√©g nincs term√©k r√∂gz√≠tve</p>';
            } else {
                // Csoportos√≠t√°s illat+t√≠pus+m√©ret szerint
                const csoportositott = {};
                
                kiontesek.forEach(kiontes => {
                    const kulcs = `${kiontes.illatId}-${kiontes.termekTipus}-${kiontes.meret}`;
                    
                    if (!csoportositott[kulcs]) {
                        csoportositott[kulcs] = {
                            illatId: kiontes.illatId,
                            illatNev: kiontes.illatNev,
                            termekTipus: kiontes.termekTipus,
                            termekTipusNev: kiontes.termekTipusNev,
                            meret: kiontes.meret,
                            osszesDarab: 0,
                            elsoKiontesIdopont: kiontes.datum,
                            tetelek: []
                        };
                    }
                    
                    csoportositott[kulcs].osszesDarab += kiontes.darabszam;
                    csoportositott[kulcs].tetelek.push(kiontes);
                    
                    // Legkor√°bbi ki√∂nt√©s
                    if (new Date(kiontes.datum) < new Date(csoportositott[kulcs].elsoKiontesIdopont)) {
                        csoportositott[kulcs].elsoKiontesIdopont = kiontes.datum;
                    }
                });
                
                const csoportositottTomb = Object.values(csoportositott)
                    .sort((a, b) => a.illatNev.localeCompare(b.illatNev, 'hu')); // ABC SORREND
                
                kiontesLista.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs md:text-sm">
                            <thead class="bg-orange-100 border-b-2 border-orange-300">
                                <tr>
                                    <th class="text-left p-1 md:p-2 font-semibold text-orange-900">Illat</th>
                                    <th class="text-left p-1 md:p-2 font-semibold text-orange-900">T√≠pus / M√©ret</th>
                                    <th class="text-center p-1 md:p-2 font-semibold text-orange-900">Darab</th>
                                    <th class="text-center p-1 md:p-2 font-semibold text-orange-900 hidden md:table-cell">C√≠mke</th>
                                    <th class="text-center p-1 md:p-2 font-semibold text-orange-900 hidden md:table-cell">Ki√∂ntve</th>
                                    <th class="text-center p-1 md:p-2 font-semibold text-orange-900"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${csoportositottTomb.map(csoport => {
                                    const kulcs = getCimkeKulcs(csoport.illatId, csoport.termekTipus, csoport.meret);
                                    const keszletMennyiseg = cimkeKeszlet[kulcs] || 0;
                                    const eleg = keszletMennyiseg >= csoport.osszesDarab;
                                    
                                    return `
                                        <tr class="border-b border-orange-200 hover:bg-orange-50">
                                            <td class="p-1 md:p-2 font-medium text-orange-900">${csoport.illatNev}</td>
                                            <td class="p-1 md:p-2 text-gray-700">
                                                <div class="hidden md:block">${csoport.termekTipusNev} - ${csoport.meret}</div>
                                                <div class="md:hidden text-xs">${csoport.termekTipusNev.substring(0, 4)}-${csoport.meret.substring(0, 5)}</div>
                                            </td>
                                            <td class="p-1 md:p-2 text-center">
                                                <span class="font-bold text-orange-900">${csoport.osszesDarab} db</span>
                                                ${csoport.tetelek.length > 1 ? `<div class="text-xs text-gray-500">(${csoport.tetelek.length} t√©tel)</div>` : ''}
                                            </td>
                                            <td class="p-1 md:p-2 text-center hidden md:table-cell">
                                                <span class="${eleg ? 'text-green-600' : 'text-red-600'} text-xs font-medium">
                                                    ${keszletMennyiseg} db ${!eleg ? '‚ö†Ô∏è' : '‚úì'}
                                                </span>
                                            </td>
                                            <td class="p-1 md:p-2 text-center text-xs text-gray-600 hidden md:table-cell">${formatDatum(csoport.elsoKiontesIdopont)}</td>
                                            <td class="p-1 md:p-2 text-center">
                                                <div class="flex gap-0.5 md:gap-1 justify-center flex-wrap">
                                                    <button onclick="csoportCimkezTeljes('${kulcs}', ${csoport.osszesDarab})" 
                                                        class="px-1 md:px-3 py-1 md:py-1.5 rounded text-xs font-medium ${
                                                        eleg ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-400 text-white cursor-not-allowed'
                                                    }" ${!eleg ? 'disabled' : ''} title="Mind c√≠mk√©z">
                                                        <span class="md:hidden">‚úì</span>
                                                        <span class="hidden md:inline">Mind</span>
                                                    </button>
                                                    <button onclick="csoportCimkezReszleges('${kulcs}', ${csoport.osszesDarab}, ${keszletMennyiseg})" 
                                                        class="px-1 md:px-3 py-1 md:py-1.5 rounded text-xs font-medium bg-purple-600 text-white hover:bg-purple-700" title="R√©szleges c√≠mk√©z√©s">
                                                        <span class="md:hidden">üè∑Ô∏è</span>
                                                        <span class="hidden md:inline">R√©szl.</span>
                                                    </button>
                                                    <button onclick="csoportTorolCimkezetlen('${kulcs}')" 
                                                        class="px-1 md:px-2 py-1 md:py-1.5 bg-red-600 text-white rounded hover:bg-red-700 text-xs" title="T√∂rl√©s">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // K√©sz term√©kek lista - CSOPORTOS√çTVA - KOMPAKT
            const keszTermekekLista = document.getElementById('keszTermekekLista');
            const keszTermekOsszesito = document.getElementById('keszTermekOsszesito');
            
            if (keszTermekekLista) {
                if (keszTermekek.length === 0) {
                    keszTermekekLista.innerHTML = '<p class="text-gray-500 text-center py-8">M√©g nincs k√©sz c√≠mk√©zett term√©k</p>';
                    keszTermekOsszesito.innerHTML = '';
                } else {
                    // Csoportos√≠t√°s illat+t√≠pus+m√©ret szerint
                    const csoportositott = {};
                    
                    keszTermekek.forEach(termek => {
                        const kulcs = `${termek.illatId}-${termek.termekTipus}-${termek.meret}`;
                        
                        if (!csoportositott[kulcs]) {
                            csoportositott[kulcs] = {
                                illatNev: termek.illatNev,
                                termekTipusNev: termek.termekTipusNev,
                                meret: termek.meret,
                                osszesDarab: 0,
                                elsoKiontesIdopont: termek.datum,
                                utolsoCimkezesIdopont: termek.cimkezveIdopont,
                                megjegyzes: termek.megjegyzes,
                                tetelek: []
                            };
                        }
                        
                        csoportositott[kulcs].osszesDarab += termek.darabszam;
                        csoportositott[kulcs].tetelek.push(termek);
                        
                        // Legkor√°bbi ki√∂nt√©s √©s legutols√≥ c√≠mk√©z√©s d√°tuma
                        if (new Date(termek.datum) < new Date(csoportositott[kulcs].elsoKiontesIdopont)) {
                            csoportositott[kulcs].elsoKiontesIdopont = termek.datum;
                        }
                        if (new Date(termek.cimkezveIdopont) > new Date(csoportositott[kulcs].utolsoCimkezesIdopont)) {
                            csoportositott[kulcs].utolsoCimkezesIdopont = termek.cimkezveIdopont;
                        }
                    });
                    
                    let csoportositottTomb = Object.values(csoportositott);
                    
                    // √ñSSZES√çT≈ê SZ√ÅM√çT√ÅS - T√≠pus + m√©ret szerint
                    const osszesites = {};
                    csoportositottTomb.forEach(c => {
                        const kulcs = `${c.termekTipusNev} - ${c.meret}`;
                        if (!osszesites[kulcs]) {
                            osszesites[kulcs] = 0;
                        }
                        osszesites[kulcs] += c.osszesDarab;
                    });
                    
                    // √ñsszes√≠t≈ë megjelen√≠t√©se
                    const osszesitesHTML = Object.entries(osszesites)
                        .sort(([a], [b]) => a.localeCompare(b, 'hu'))
                        .map(([tipus, darab]) => 
                            `<div class="flex justify-between items-center p-2 bg-emerald-50 rounded">
                                <span class="text-sm font-medium text-emerald-900">${tipus}</span>
                                <span class="font-bold text-emerald-700">${darab} db</span>
                            </div>`
                        ).join('');
                    
                    keszTermekOsszesito.innerHTML = `
                        <div class="bg-gradient-to-r from-emerald-100 to-teal-100 rounded-lg p-4 border-2 border-emerald-300">
                            <h3 class="font-bold text-emerald-900 mb-3 flex items-center gap-2">
                                <span>üìä</span>
                                <span>K√©szlet √∂sszes√≠t≈ë kateg√≥ri√°nk√©nt</span>
                            </h3>
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-2">
                                ${osszesitesHTML}
                            </div>
                        </div>
                    `;
                    
                    // RENDEZ√âS a kiv√°lasztott m√≥d szerint
                    if (keszTermekRendezes === 'abc') {
                        csoportositottTomb.sort((a, b) => a.illatNev.localeCompare(b.illatNev, 'hu'));
                    } else if (keszTermekRendezes === 'mennyiseg') {
                        csoportositottTomb.sort((a, b) => b.osszesDarab - a.osszesDarab);
                    } else {
                        // datum - legfrissebb c√≠mk√©z√©s
                        csoportositottTomb.sort((a, b) => 
                            new Date(b.utolsoCimkezesIdopont) - new Date(a.utolsoCimkezesIdopont)
                        );
                    }
                    
                    // KOMPAKT t√°bl√°zat st√≠lus
                    keszTermekekLista.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs md:text-sm">
                                <thead class="bg-emerald-100 border-b-2 border-emerald-300">
                                    <tr>
                                        <th class="text-left p-1 md:p-2 font-semibold text-emerald-900">Illat</th>
                                        <th class="text-left p-1 md:p-2 font-semibold text-emerald-900">T√≠pus / M√©ret</th>
                                        <th class="text-center p-1 md:p-2 font-semibold text-emerald-900">Darab</th>
                                        <th class="text-center p-1 md:p-2 font-semibold text-emerald-900 hidden md:table-cell">C√≠mk√©zve</th>
                                        <th class="text-center p-1 md:p-2 font-semibold text-emerald-900"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${csoportositottTomb.map(csoport => `
                                        <tr class="border-b border-emerald-200 hover:bg-emerald-50">
                                            <td class="p-1 md:p-2 font-medium text-emerald-900">${csoport.illatNev}</td>
                                            <td class="p-1 md:p-2 text-gray-700">
                                                <span class="hidden md:inline">${csoport.termekTipusNev} - ${csoport.meret}</span>
                                                <span class="md:hidden text-xs">${csoport.termekTipusNev.substring(0, 4)}-${csoport.meret.substring(0, 5)}</span>
                                            </td>
                                            <td class="p-1 md:p-2 text-center font-bold text-emerald-900">${csoport.osszesDarab} db</td>
                                            <td class="p-1 md:p-2 text-center text-xs text-gray-600 hidden md:table-cell">${formatDatum(csoport.utolsoCimkezesIdopont)}</td>
                                            <td class="p-1 md:p-2 text-center">
                                                <div class="flex gap-0.5 md:gap-1 justify-center">
                                                    ${aktivDraft 
                                                        ? `<button onclick="draftTermekHozzaad('${csoport.illatNev}', '${csoport.termekTipusNev}', '${csoport.meret}', ${csoport.osszesDarab})" 
                                                            class="text-blue-600 hover:text-blue-800 text-base md:text-lg px-1 md:px-2 py-0.5 md:py-1 font-bold" title="Hozz√°ad a kisz√°ll√≠t√°shoz">
                                                            ‚ûï
                                                        </button>`
                                                        : `<button onclick="alert('Nincs akt√≠v kisz√°ll√≠t√°s! Hozz l√©tre egyet a Kisz√°ll√≠t√°s tab-on.')" 
                                                            class="text-gray-400 text-base md:text-lg px-1 md:px-2 py-0.5 md:py-1" title="Nincs akt√≠v kisz√°ll√≠t√°s">
                                                            üîí
                                                        </button>`
                                                    }
                                                    <button onclick="keszTermekSzerkeszt('${csoport.illatNev}', '${csoport.termekTipusNev}', '${csoport.meret}', ${csoport.osszesDarab})" 
                                                        class="text-blue-600 hover:text-blue-800 text-base md:text-lg px-1 md:px-2 py-0.5 md:py-1" title="Mennyis√©g szerkeszt√©se">
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button onclick="csoportTorol('${csoport.illatNev}', '${csoport.termekTipusNev}', '${csoport.meret}')" 
                                                        class="text-red-600 hover:text-red-800 text-base md:text-lg px-1 md:px-2 py-0.5 md:py-1" title="T√∂rl√©s">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }
        }

        // Enter billenty≈± kezel√©s
        document.addEventListener('DOMContentLoaded', () => {
            // betolt() m√°r nem kell itt - az onAuthStateChanged h√≠vja meg
            
            document.getElementById('ujIllatNev').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') illatHozzaad();
            });
        });
    </script>
</body>
</html>